<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊåÇÊú∫Ê∏∏Êàè</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .avatar-panel {
            background: linear-gradient(145deg, #f0f0f0, #ffffff);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 5px 5px 15px #d9d9d9, -5px -5px 15px #ffffff;
        }

        .avatar {
            font-size: 100px;
            margin-bottom: 15px;
            display: inline-block;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .level-display {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .level-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 20px;
        }

        .stats-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            margin-bottom: 12px;
            text-align: left;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .stat-value.highlight {
            color: #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .exp-rate {
            color: #4CAF50;
            font-size: 14px;
            margin-top: 8px;
        }

        .level-up-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.5s ease, fadeOut 0.5s ease 2s forwards;
            z-index: 1000;
        }

        @keyframes slideDown {
            from {
                top: -50px;
                opacity: 0;
            }
            to {
                top: 20px;
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        .exp-gain {
            position: absolute;
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        .buttons-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .game-btn {
            flex: 1;
            min-width: 100px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            position: relative;
        }

        .game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .game-btn:active {
            transform: translateY(0);
        }

        .game-btn:disabled {
            background: #cccccc;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

        .game-btn:disabled:hover {
            transform: none;
        }

        .level-up-btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .level-up-btn:hover {
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
        }

        .insufficient-exp-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.5s ease, fadeOut 0.5s ease 1.5s forwards;
            z-index: 1000;
        }

        .debug-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }

        .reset-btn {
            background: #666;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 5px;
            cursor: pointer;
            opacity: 0.7;
        }

        .reset-btn:hover {
            opacity: 1;
        }

        .quick-level-btn {
            background: #FF9800;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 5px;
            cursor: pointer;
            opacity: 0.7;
            margin-left: 10px;
        }

        .quick-level-btn:hover {
            opacity: 1;
        }

        .scene-switch-btn {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
        }

        .scene-switch-btn:hover {
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.6);
        }

        .backpack-btn {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
        }

        .backpack-btn:hover {
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.6);
        }

        .backpack-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .backpack-panel.active {
            display: flex;
        }

        .backpack-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .backpack-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .backpack-header h2 {
            color: #333;
            margin: 0;
        }

        .backpack-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .backpack-slot {
            aspect-ratio: 1;
            background: linear-gradient(145deg, #f0f0f0, #ffffff);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            box-shadow: inset 2px 2px 5px #d9d9d9, inset -2px -2px 5px #ffffff;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .backpack-slot:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .backpack-slot.empty {
            color: #cccccc;
            font-size: 24px;
        }

        .backpack-slot.locked {
            background: linear-gradient(145deg, #e0e0e0, #f0f0f0);
            cursor: not-allowed;
            position: relative;
            overflow: hidden;
        }

        .backpack-slot.locked::before {
            content: 'üîí';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
            opacity: 0.5;
        }

        .backpack-slot .unlock-level {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #666;
            white-space: nowrap;
        }

        .backpack-slot .unlock-level::before {
            content: 'Lv.';
            font-size: 8px;
        }

        .backpack-slot .item-count {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .scene-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .scene-panel.active {
            display: flex;
        }

        .scene-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .scene-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .scene-header h2 {
            color: #333;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .close-btn:hover {
            background: #f0f0f0;
        }

        .scene-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .scene-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .scene-item:hover:not(.locked) {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .scene-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .scene-item.active .scene-emoji,
        .scene-item.active .scene-name,
        .scene-item.active .scene-rate {
            color: white;
        }

        .scene-item.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .scene-emoji {
            font-size: 40px;
            margin-bottom: 8px;
        }

        .scene-name {
            font-size: 12px;
            color: #333;
            font-weight: bold;
            margin-bottom: 5px;
            word-break: break-all;
        }

        .scene-rate {
            font-size: 11px;
            color: #666;
        }

        .scene-locked-text {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .scene-unlock-badge {
            background: #ffd700;
            color: #333;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 5px;
            display: inline-block;
        }

        .current-scene-info {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .current-scene-info .scene-label {
            color: #1976D2;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .current-scene-info .scene-value {
            font-size: 20px;
            font-weight: bold;
            color: #1976D2;
        }

        .locked-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.5s ease, fadeOut 0.5s ease 1.5s forwards;
            z-index: 1000;
        }

        .item-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            pointer-events: none;
            z-index: 4000;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .item-tooltip .item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-tooltip .item-description {
            font-size: 12px;
            color: #ccc;
        }

        .item-tooltip .item-effect {
            font-size: 12px;
            color: #4CAF50;
            margin-top: 3px;
        }

        .backpack-slot.clickable {
            cursor: pointer;
            border: 2px solid transparent;
        }

        .backpack-slot.clickable:hover {
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
        }

        .item-drop-animation {
            position: fixed;
            font-size: 30px;
            pointer-events: none;
            z-index: 5000;
            animation: dropToBackpack 1.5s ease-in-out forwards;
        }

        @keyframes dropToBackpack {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            50% {
                transform: translate(var(--mid-x), var(--mid-y)) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(var(--target-x), var(--target-y)) scale(0.8);
            }
        }

        .drop-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 5000;
            animation: dropNotificationPop 2s ease-out forwards;
        }

        @keyframes dropNotificationPop {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            40% {
                transform: translate(-50%, -50%) scale(1);
            }
            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        .backpack-full-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 5000;
            animation: dropNotificationPop 2s ease-out forwards;
        }

        .attributes-btn {
            background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4);
        }

        .attributes-btn:hover {
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.6);
        }

        .attributes-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3500;
        }

        .attributes-panel.active {
            display: flex;
        }

        .attributes-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .attributes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .attributes-header h2 {
            color: #333;
            margin: 0;
            font-size: 24px;
        }

        .attributes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .attribute-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid;
            transition: transform 0.2s ease;
        }

        .attribute-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .attribute-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .attribute-value {
            font-size: 24px;
            font-weight: bold;
        }

        .attribute-growth {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* Â±ûÊÄßÈ¢úËâ≤‰∏ªÈ¢ò */
        .attribute-health { border-left-color: #f44336; background: linear-gradient(145deg, #ffebee, #ffffff); }
        .attribute-health .attribute-name { color: #d32f2f; }

        .attribute-mana { border-left-color: #2196f3; background: linear-gradient(145deg, #e3f2fd, #ffffff); }
        .attribute-mana .attribute-name { color: #1976d2; }

        .attribute-attack { border-left-color: #ff9800; background: linear-gradient(145deg, #fff3e0, #ffffff); }
        .attribute-attack .attribute-name { color: #f57c00; }

        .attribute-defense { border-left-color: #4caf50; background: linear-gradient(145deg, #e8f5e8, #ffffff); }
        .attribute-defense .attribute-name { color: #388e3c; }

        .attribute-accuracy { border-left-color: #00bcd4; background: linear-gradient(145deg, #e0f7fa, #ffffff); }
        .attribute-accuracy .attribute-name { color: #0097a7; }

        .attribute-evasion { border-left-color: #9c27b0; background: linear-gradient(145deg, #f3e5f5, #ffffff); }
        .attribute-evasion .attribute-name { color: #7b1fa2; }

        .attribute-crit { border-left-color: #e91e63; background: linear-gradient(145deg, #fce4ec, #ffffff); }
        .attribute-crit .attribute-name { color: #c2185b; }

        .attribute-crit-def { border-left-color: #607d8b; background: linear-gradient(145deg, #eceff1, #ffffff); }
        .attribute-crit-def .attribute-name { color: #455a64; }

        .attribute-icon {
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }

        .close-btn:hover {
            background: #f0f0f0;
        }

        .equipment-btn {
            background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%);
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
        }

        .equipment-btn:hover {
            box-shadow: 0 6px 20px rgba(233, 30, 99, 0.6);
        }

        .equipment-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3600;
        }

        .equipment-panel.active {
            display: flex;
        }

        .equipment-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .equipment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .equipment-header h2 {
            color: #333;
            margin: 0;
            font-size: 24px;
        }

        .equipment-section {
            margin-bottom: 25px;
        }

        .equipment-section h3 {
            color: #E91E63;
            font-size: 18px;
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 4px solid #E91E63;
        }

        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .equipment-slot {
            background: linear-gradient(145deg, #f0f0f0, #ffffff);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .equipment-slot:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(233, 30, 99, 0.3);
            border-color: #E91E63;
        }

        .equipment-slot.equipped {
            background: linear-gradient(145deg, #fce4ec, #ffffff);
            border-color: #E91E63;
        }

        .slot-name {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .slot-icon {
            font-size: 40px;
            margin-bottom: 8px;
        }

        .equipment-name {
            font-size: 12px;
            color: #333;
            font-weight: bold;
        }

        .equipment-name.empty {
            color: #999;
        }

        /* ÊàòÊñóÁïåÈù¢Ê†∑Âºè */
        .battle-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 7000;
            flex-direction: column;
        }

        .battle-overlay.active {
            display: flex;
        }

        .battle-scene {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 50px;
            margin-bottom: 30px;
        }

        .battle-player, .battle-monster {
            text-align: center;
            animation: battleEnter 0.5s ease-out;
        }

        .battle-player {
            animation-delay: 0s;
        }

        .battle-monster {
            animation-delay: 0.3s;
        }

        @keyframes battleEnter {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .battle-vs {
            font-size: 48px;
            font-weight: bold;
            color: #ff4444;
            text-shadow: 0 0 20px #ff0000;
            animation: vsPulse 1s ease-in-out infinite;
        }

        @keyframes vsPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }

        .character-emoji {
            font-size: 80px;
            margin-bottom: 10px;
            animation: characterBounce 1s ease-in-out infinite;
        }

        .battle-monster .character-emoji {
            animation: monsterShake 0.5s ease-in-out infinite;
        }

        @keyframes characterBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes monsterShake {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-5px);
            }
            75% {
                transform: translateX(5px);
            }
        }

        .character-name {
            font-size: 20px;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }

        .character-hp {
            font-size: 16px;
            color: #4CAF50;
        }

        .battle-log {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 150px;
            overflow-y: auto;
            color: white;
            font-size: 14px;
        }

        .battle-log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 5px;
        }

        .battle-log-entry.player-attack {
            background: rgba(76, 175, 80, 0.3);
        }

        .battle-log-entry.monster-attack {
            background: rgba(244, 67, 54, 0.3);
        }

        .battle-log-entry.victory {
            background: rgba(255, 215, 0, 0.5);
            font-weight: bold;
            text-align: center;
        }

        .battle-log-entry.defeat {
            background: rgba(255, 0, 0, 0.5);
            font-weight: bold;
            text-align: center;
        }

        .battle-timer {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 500;
            display: none;
        }

        .battle-timer.active {
            display: block;
        }

        .battle-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 8000;
            animation: battleNotificationPop 2s ease-out forwards;
        }

        @keyframes battleNotificationPop {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            40% {
                transform: translate(-50%, -50%) scale(1);
            }
            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        @keyframes attackRight {
            0% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(50px);
            }
            100% {
                transform: translateX(0);
            }
        }

        @keyframes attackLeft {
            0% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(-50px);
            }
            100% {
                transform: translateX(0);
            }
        }

        .attacking-right {
            animation: attackRight 0.3s ease-in-out;
        }

        .attacking-left {
            animation: attackLeft 0.3s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="debug-controls">
        <button class="reset-btn" id="reset-btn">ÈáçÁΩÆÊ∏∏Êàè</button>
        <button class="quick-level-btn" id="quick-level-btn">Âø´ÈÄüÂçáÁ∫ß</button>
    </div>

    <div class="battle-timer" id="battle-timer">ÈáéÊÄ™Âá∫Áé∞ÂÄíËÆ°Êó∂: <span id="battle-countdown">30</span>Áßí</div>

    <div class="game-container">
        <div class="avatar-panel">
            <div class="avatar" id="player-avatar">üòä</div>
            <div class="level-display">
                <span class="level-badge">Lv. <span id="level">1</span></span>
            </div>
        </div>

        <div class="stats-panel">
            <div class="stat-item">
                <div class="stat-label">ÂΩìÂâçÂú∫ÊôØ</div>
                <div class="current-scene-info">
                    <div class="scene-label">Âú∫ÊôØ</div>
                    <div class="scene-value"><span id="current-scene-emoji">üòä</span> <span id="current-scene-name">ÂàùÂøÉ‰πãÂú∞</span></div>
                </div>
            </div>

            <div class="stat-item">
                <div class="stat-label">ÂΩìÂâçÁªèÈ™å</div>
                <div class="stat-value highlight"><span id="current-exp">0</span> / <span id="next-level-exp">100</span></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
            </div>

            <div class="stat-item">
                <div class="stat-label">ÁªèÈ™åËé∑ÂèñÈÄüÁéá</div>
                <div class="stat-value"><span id="exp-rate">1</span> ÁªèÈ™å/Áßí</div>
            </div>
        </div>

        <div class="buttons-container">
            <button class="game-btn" id="gain-exp-btn" style="position: relative;">
                Ëé∑ÂæóÁªèÈ™å
            </button>
            <button class="game-btn level-up-btn" id="level-up-btn">
                ÂçáÁ∫ß
            </button>
            <button class="game-btn scene-switch-btn" id="scene-switch-btn">
                Âú∫ÊôØÂàáÊç¢
            </button>
            <button class="game-btn backpack-btn" id="backpack-btn">
                ËÉåÂåÖ
            </button>
            <button class="game-btn attributes-btn" id="attributes-btn" disabled>
                Â±ûÊÄß
            </button>
            <button class="game-btn equipment-btn" id="equipment-btn" disabled>
                Ë£ÖÂ§á
            </button>
        </div>
    </div>

    <div class="backpack-panel" id="backpack-panel">
        <div class="backpack-content">
            <div class="backpack-header">
                <h2>ËÉåÂåÖ</h2>
                <button class="close-btn" id="close-backpack-btn">&times;</button>
            </div>
            <div class="backpack-grid" id="backpack-grid">
            </div>
        </div>
    </div>

    <div class="scene-panel" id="scene-panel">
        <div class="scene-content">
            <div class="scene-header">
                <h2>ÈÄâÊã©Âú∫ÊôØ</h2>
                <button class="close-btn" id="close-scene-btn">&times;</button>
            </div>
            <div class="scene-list" id="scene-list">
            </div>
        </div>
    </div>

    <div class="attributes-panel" id="attributes-panel">
        <div class="attributes-content">
            <div class="attributes-header">
                <h2>Áé©ÂÆ∂Â±ûÊÄß</h2>
                <button class="close-btn" id="close-attributes-btn">&times;</button>
            </div>
            <div class="attributes-grid" id="attributes-grid">
            </div>
        </div>
    </div>

    <div class="equipment-panel" id="equipment-panel">
        <div class="equipment-content">
            <div class="equipment-header">
                <h2>Ë£ÖÂ§áÁ≥ªÁªü</h2>
                <button class="close-btn" id="close-equipment-btn">&times;</button>
            </div>
            <div class="equipment-section">
                <h3>ÊîªÂáªË£ÖÂ§á</h3>
                <div class="equipment-grid">
                    <div class="equipment-slot" data-slot="weapon">
                        <div class="slot-name">Ê≠¶Âô®</div>
                        <div class="slot-icon" id="slot-weapon">‚öîÔ∏è</div>
                        <div class="equipment-name" id="name-weapon">Á©∫</div>
                    </div>
                    <div class="equipment-slot" data-slot="wristguard">
                        <div class="slot-name">Êä§ËÖï</div>
                        <div class="slot-icon" id="slot-wristguard">ü¶æ</div>
                        <div class="equipment-name" id="name-wristguard">Á©∫</div>
                    </div>
                    <div class="equipment-slot" data-slot="necklace">
                        <div class="slot-name">È°πÈìæ</div>
                        <div class="slot-icon" id="slot-necklace">üìø</div>
                        <div class="equipment-name" id="name-necklace">Á©∫</div>
                    </div>
                    <div class="equipment-slot" data-slot="gloves">
                        <div class="slot-name">ÊâãÂ•ó</div>
                        <div class="slot-icon" id="slot-gloves">üß§</div>
                        <div class="equipment-name" id="name-gloves">Á©∫</div>
                    </div>
                </div>
            </div>
            <div class="equipment-section">
                <h3>Èò≤Âæ°Ë£ÖÂ§á</h3>
                <div class="equipment-grid">
                    <div class="equipment-slot" data-slot="helmet">
                        <div class="slot-name">Â§¥Áõî</div>
                        <div class="slot-icon" id="slot-helmet">‚õëÔ∏è</div>
                        <div class="equipment-name" id="name-helmet">Á©∫</div>
                    </div>
                    <div class="equipment-slot" data-slot="armor">
                        <div class="slot-name">Êä§Áî≤</div>
                        <div class="slot-icon" id="slot-armor">ü¶∫</div>
                        <div class="equipment-name" id="name-armor">Á©∫</div>
                    </div>
                    <div class="equipment-slot" data-slot="shoulder">
                        <div class="slot-name">Êä§ËÇ©</div>
                        <div class="slot-icon" id="slot-shoulder">üõ°Ô∏è</div>
                        <div class="equipment-name" id="name-shoulder">Á©∫</div>
                    </div>
                    <div class="equipment-slot" data-slot="boots">
                        <div class="slot-name">Èù¥Â≠ê</div>
                        <div class="slot-icon" id="slot-boots">üë¢</div>
                        <div class="equipment-name" id="name-boots">Á©∫</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊàòÊñóÂä®ÁîªÂ±Ç -->
    <div class="battle-overlay" id="battle-overlay" style="display: none;">
        <div class="battle-scene">
            <div class="battle-player" id="battle-player">
                <div class="character-emoji">üòä</div>
                <div class="character-name">Áé©ÂÆ∂</div>
                <div class="character-hp">HP: <span id="player-hp">100</span>/<span id="player-max-hp">100</span></div>
            </div>
            <div class="battle-vs">VS</div>
            <div class="battle-monster" id="battle-monster">
                <div class="character-emoji" id="monster-emoji">üëπ</div>
                <div class="character-name" id="monster-name">ÈáéÊÄ™</div>
                <div class="character-hp">HP: <span id="monster-hp">100</span>/<span id="monster-max-hp">100</span></div>
            </div>
        </div>
        <div class="battle-log" id="battle-log"></div>
    </div>

    <script>
        // Âú∫ÊôØÊï∞ÊçÆÔºà20‰∏™Âú∫ÊôØÔºåÊØè5Á∫ßËß£ÈîÅ‰∏Ä‰∏™Ôºâ
        const scenes = [
            { id: 0, name: 'ÂàùÂøÉ‰πãÂú∞', emoji: 'üòä', expRate: 1, unlockLevel: 1 },
            { id: 1, name: 'ÈùôË∞ßÊ£ÆÊûó', emoji: 'üå≤', expRate: 2, unlockLevel: 5 },
            { id: 2, name: 'Èò≥ÂÖâÊµ∑Êª©', emoji: 'üèñÔ∏è', expRate: 3, unlockLevel: 10 },
            { id: 3, name: 'Èõ™Â±±‰πãÂ∑Ö', emoji: 'üèîÔ∏è', expRate: 4, unlockLevel: 15 },
            { id: 4, name: 'Á•ûÁßòÊ¥ûÁ©¥', emoji: 'üï≥Ô∏è', expRate: 5, unlockLevel: 20 },
            { id: 5, name: 'ÁπÅÂçéÈÉΩÂ∏Ç', emoji: 'üèôÔ∏è', expRate: 6, unlockLevel: 25 },
            { id: 6, name: 'Êµ∑Â∫ï‰∏ñÁïå', emoji: 'üêö', expRate: 7, unlockLevel: 30 },
            { id: 7, name: 'Ê≤ôÊº†ÁªøÊ¥≤', emoji: 'üå¥', expRate: 8, unlockLevel: 35 },
            { id: 8, name: 'ÊòüÁ©∫ËçâÂéü', emoji: 'üåå', expRate: 9, unlockLevel: 40 },
            { id: 9, name: 'Ê®±Ëä±Â∫≠Èô¢', emoji: 'üå∏', expRate: 10, unlockLevel: 45 },
            { id: 10, name: 'ËøúÂè§ÈÅóËøπ', emoji: 'üèõÔ∏è', expRate: 12, unlockLevel: 50 },
            { id: 11, name: 'ÁÅ´Â±±ÁßòÂ¢É', emoji: 'üåã', expRate: 14, unlockLevel: 55 },
            { id: 12, name: 'ÂΩ©ËôπÊ°•', emoji: 'üåà', expRate: 16, unlockLevel: 60 },
            { id: 13, name: '‰∫ëÁ´Ø‰πã‰∏ä', emoji: '‚òÅÔ∏è', expRate: 18, unlockLevel: 65 },
            { id: 14, name: 'Ê∞¥Êô∂ÂÆ´ÊÆø', emoji: 'üíé', expRate: 20, unlockLevel: 70 },
            { id: 15, name: 'ÊûÅÂÖâÂÜ∞Âéü', emoji: '‚ú®', expRate: 25, unlockLevel: 75 },
            { id: 16, name: 'È≠îÊ≥ïÊ£ÆÊûó', emoji: 'üîÆ', expRate: 30, unlockLevel: 80 },
            { id: 17, name: 'Èæô‰πãÂ∑¢Á©¥', emoji: 'üêâ', expRate: 35, unlockLevel: 85 },
            { id: 18, name: 'Â§©ÁïåÂú£Âüü', emoji: '‚≠ê', expRate: 40, unlockLevel: 90 },
            { id: 19, name: 'Ê∑∑Ê≤åËôöÁ©∫', emoji: 'üåÄ', expRate: 50, unlockLevel: 95 }
        ];

        // Âú∫ÊôØÊéâËêΩÊï∞ÊçÆ
        const sceneDrops = {
            0: [ // ÂàùÂøÉ‰πãÂú∞ (Lv.1)
                { itemId: 'di_ling_dan', probability: 0.10 },
                { itemId: 'health_grass', probability: 0.005 },
                { itemId: 'mana_herb', probability: 0.005 }
            ],
            1: [ // ÈùôË∞ßÊ£ÆÊûó (Lv.5)
                { itemId: 'di_ling_dan', probability: 0.08 },
                { itemId: 'tian_ling_dan', probability: 0.05 },
                { itemId: 'health_grass', probability: 0.008 },
                { itemId: 'mana_herb', probability: 0.008 },
                { itemId: 'attack_pearl', probability: 0.004 }
            ],
            2: [ // Èò≥ÂÖâÊµ∑Êª© (Lv.10)
                { itemId: 'di_ling_dan', probability: 0.06 },
                { itemId: 'tian_ling_dan', probability: 0.06 },
                { itemId: 'xiao_huan_dan', probability: 0.04 },
                { itemId: 'mana_herb', probability: 0.006 },
                { itemId: 'attack_pearl', probability: 0.006 },
                { itemId: 'defense_scale', probability: 0.003 }
            ],
            3: [ // Èõ™Â±±‰πãÂ∑Ö (Lv.15)
                { itemId: 'tian_ling_dan', probability: 0.07 },
                { itemId: 'xiao_huan_dan', probability: 0.05 },
                { itemId: 'da_huan_dan', probability: 0.03 },
                { itemId: 'health_essence', probability: 0.004 },
                { itemId: 'attack_pearl', probability: 0.005 },
                { itemId: 'defense_scale', probability: 0.005 },
                { itemId: 'accuracy_feather', probability: 0.003 },
                // Ë£ÖÂ§áÊéâËêΩ
                { itemId: 'iron_sword', probability: 0.008 },
                { itemId: 'leather_wrist', probability: 0.008 },
                { itemId: 'copper_necklace', probability: 0.008 },
                { itemId: 'cloth_gloves', probability: 0.008 },
                { itemId: 'leather_helmet', probability: 0.008 },
                { itemId: 'cloth_armor', probability: 0.008 },
                { itemId: 'leather_shoulder', probability: 0.008 },
                { itemId: 'cloth_boots', probability: 0.008 }
            ],
            4: [ // Á•ûÁßòÊ¥ûÁ©¥ (Lv.20)
                { itemId: 'xiao_huan_dan', probability: 0.06 },
                { itemId: 'da_huan_dan', probability: 0.05 },
                { itemId: 'jiu_zhuan_hun_hun_dan', probability: 0.02 },
                { itemId: 'mana_essence', probability: 0.003 },
                { itemId: 'attack_stone', probability: 0.004 },
                { itemId: 'defense_scale', probability: 0.004 },
                { itemId: 'evasion_wind', probability: 0.003 },
                { itemId: 'crit_fang', probability: 0.002 },
                // Ë£ÖÂ§áÊéâËêΩ
                { itemId: 'iron_sword', probability: 0.006 },
                { itemId: 'leather_wrist', probability: 0.006 },
                { itemId: 'copper_necklace', probability: 0.006 },
                { itemId: 'cloth_gloves', probability: 0.006 },
                { itemId: 'leather_helmet', probability: 0.006 },
                { itemId: 'cloth_armor', probability: 0.006 },
                { itemId: 'leather_shoulder', probability: 0.006 },
                { itemId: 'cloth_boots', probability: 0.006 }
            ],
            5: [ // ÁπÅÂçéÈÉΩÂ∏Ç (Lv.25)
                { itemId: 'da_huan_dan', probability: 0.06 },
                { itemId: 'jiu_zhuan_hun_hun_dan', probability: 0.04 },
                { itemId: 'xian_lu', probability: 0.03 },
                { itemId: 'health_essence', probability: 0.003 },
                { itemId: 'attack_stone', probability: 0.003 },
                { itemId: 'defense_essence', probability: 0.002 },
                { itemId: 'accuracy_feather', probability: 0.003 },
                { itemId: 'crit_fang', probability: 0.002 },
                // Ë£ÖÂ§áÊéâËêΩ - Lv.25Ë£ÖÂ§á
                { itemId: 'steel_blade', probability: 0.005 },
                { itemId: 'iron_wrist', probability: 0.005 },
                { itemId: 'copper_necklace', probability: 0.005 },
                { itemId: 'cloth_gloves', probability: 0.005 },
                { itemId: 'leather_helmet', probability: 0.005 },
                { itemId: 'cloth_armor', probability: 0.005 },
                { itemId: 'leather_shoulder', probability: 0.005 },
                { itemId: 'cloth_boots', probability: 0.005 }
            ],
            6: [ // Êµ∑Â∫ï‰∏ñÁïå (Lv.30)
                { itemId: 'jiu_zhuan_hun_hun_dan', probability: 0.05 },
                { itemId: 'xian_lu', probability: 0.05 },
                { itemId: 'shen_dan', probability: 0.02 },
                { itemId: 'tai_ji_dan', probability: 0.01 },
                { itemId: 'health_crystal', probability: 0.002 },
                { itemId: 'mana_essence', probability: 0.002 },
                { itemId: 'attack_stone', probability: 0.003 },
                { itemId: 'crit_claw', probability: 0.002 },
                { itemId: 'crit_def_horn', probability: 0.001 }
            ],
            7: [ // Ê≤ôÊº†ÁªøÊ¥≤ (Lv.35)
                { itemId: 'xian_lu', probability: 0.06 },
                { itemId: 'shen_dan', probability: 0.04 },
                { itemId: 'tai_ji_dan', probability: 0.02 },
                { itemId: 'hun_dun_dan', probability: 0.01 },
                { itemId: 'mana_essence', probability: 0.002 },
                { itemId: 'attack_stone', probability: 0.002 },
                { itemId: 'defense_essence', probability: 0.002 },
                { itemId: 'evasion_shadow', probability: 0.002 },
                { itemId: 'crit_claw', probability: 0.002 },
                { itemId: 'crit_def_horn', probability: 0.001 }
            ],
            8: [ // ÊòüÁ©∫ËçâÂéü (Lv.40)
                { itemId: 'shen_dan', probability: 0.05 },
                { itemId: 'tai_ji_dan', probability: 0.03 },
                { itemId: 'hun_dun_dan', probability: 0.02 },
                { itemId: 'qian_kun_dan', probability: 0.01 },
                { itemId: 'mana_crystal', probability: 0.002 },
                { itemId: 'attack_crystal', probability: 0.002 },
                { itemId: 'defense_essence', probability: 0.002 },
                { itemId: 'accuracy_eye', probability: 0.002 },
                { itemId: 'evasion_shadow', probability: 0.002 },
                { itemId: 'crit_claw', probability: 0.001 }
            ],
            9: [ // Ê®±Ëä±Â∫≠Èô¢ (Lv.45)
                { itemId: 'tai_ji_dan', probability: 0.04 },
                { itemId: 'hun_dun_dan', probability: 0.03 },
                { itemId: 'qian_kun_dan', probability: 0.01 },
                { itemId: 'defense_crystal', probability: 0.001 },
                { itemId: 'accuracy_eye', probability: 0.002 },
                { itemId: 'evasion_crystal', probability: 0.001 },
                { itemId: 'crysta_crystal', probability: 0.001 }
            ],
            10: [ // ËøúÂè§ÈÅóËøπ (Lv.50)
                { itemId: 'tai_ji_dan', probability: 0.05 },
                { itemId: 'hun_dun_dan', probability: 0.04 },
                { itemId: 'qian_kun_dan', probability: 0.02 },
                { itemId: 'health_crystal', probability: 0.001 },
                { itemId: 'attack_crystal', probability: 0.001 },
                { itemId: 'accuracy_eye', probability: 0.002 },
                { itemId: 'evasion_crystal', probability: 0.002 },
                { itemId: 'crysta_crystal', probability: 0.001 },
                { itemId: 'crit_def_shield', probability: 0.001 }
            ],
            11: [ // ÁÅ´Â±±ÁßòÂ¢É (Lv.55)
                { itemId: 'hun_dun_dan', probability: 0.05 },
                { itemId: 'qian_kun_dan', probability: 0.03 },
                { itemId: 'accuracy_crystal', probability: 0.001 },
                { itemId: 'crysta_crystal', probability: 0.002 },
                { itemId: 'crit_def_shield', probability: 0.001 }
            ],
            12: [ // ÂΩ©ËôπÊ°• (Lv.60)
                { itemId: 'hun_dun_dan', probability: 0.06 },
                { itemId: 'qian_kun_dan', probability: 0.04 },
                { itemId: 'accuracy_crystal', probability: 0.001 },
                { itemId: 'crit_def_crystal', probability: 0.001 }
            ],
            13: [ // ‰∫ëÁ´Ø‰πã‰∏ä (Lv.65)
                { itemId: 'qian_kun_dan', probability: 0.05 },
                { itemId: 'crit_def_crystal', probability: 0.001 }
            ],
            14: [ // Ê∞¥Êô∂ÂÆ´ÊÆø (Lv.70)
                { itemId: 'qian_kun_dan', probability: 0.06 },
                { itemId: 'crit_def_crystal', probability: 0.001 }
            ],
            15: [ // ÊûÅÂÖâÂÜ∞Âéü (Lv.75)
                { itemId: 'qian_kun_dan', probability: 0.07 },
                { itemId: 'crit_def_crystal', probability: 0.002 }
            ],
            16: [ // È≠îÊ≥ïÊ£ÆÊûó (Lv.80)
                { itemId: 'qian_kun_dan', probability: 0.08 },
                { itemId: 'crit_def_crystal', probability: 0.002 }
            ],
            17: [ // Èæô‰πãÂ∑¢Á©¥ (Lv.85)
                { itemId: 'qian_kun_dan', probability: 0.09 },
                { itemId: 'crit_def_crystal', probability: 0.003 }
            ],
            18: [ // Â§©ÁïåÂú£Âüü (Lv.90)
                { itemId: 'qian_kun_dan', probability: 0.10 },
                { itemId: 'crit_def_crystal', probability: 0.003 }
            ],
            19: [ // Ê∑∑Ê≤åËôöÁ©∫ (Lv.95)
                { itemId: 'qian_kun_dan', probability: 0.12 },
                { itemId: 'crit_def_crystal', probability: 0.005 }
            ]
        };

        // Áâ©ÂìÅÊï∞ÊçÆ
        const itemTypes = [
            // ÁªèÈ™å‰∏πËçØ
            { id: 'di_ling_dan', name: 'Âú∞ÁÅµ‰∏π', emoji: 'üíä', description: 'Ëï¥Âê´Â§ßÂú∞Á≤æÂçéÁöÑÁ•ûÁßò‰∏πËçØ', expValue: 100, requiredLevel: 1, type: 'exp' },
            { id: 'tian_ling_dan', name: 'Â§©ÁÅµ‰∏π', emoji: '‚ú®', description: 'Ëï¥Âê´Â§©Á©∫Á≤æÂçéÁöÑÁ•ûÁßò‰∏πËçØ', expValue: 1000, requiredLevel: 8, type: 'exp' },
            { id: 'xiao_huan_dan', name: 'Â∞èËøò‰∏π', emoji: 'üîÆ', description: 'Ëï¥Âê´ÁîüÂëΩÁ≤æÂçéÁöÑÂàùÁ∫ß‰∏πËçØ', expValue: 2000, requiredLevel: 11, type: 'exp' },
            { id: 'da_huan_dan', name: 'Â§ßËøò‰∏π', emoji: 'üíé', description: 'Ëï¥Âê´ÁîüÂëΩÁ≤æÂçéÁöÑ‰∏≠Á∫ß‰∏πËçØ', expValue: 5000, requiredLevel: 14, type: 'exp' },
            { id: 'jiu_zhuan_hun_hun_dan', name: '‰πùËΩ¨ËøòÈ≠Ç‰∏π', emoji: 'üåü', description: 'Ëï¥Âê´ÁîüÂëΩÁ≤æÂçéÁöÑÈ´òÁ∫ß‰∏πËçØ', expValue: 20000, requiredLevel: 18, type: 'exp' },
            { id: 'xian_lu', name: '‰ªôÈú≤', emoji: 'üíß', description: 'Ëï¥Âê´‰ªôÊ∞îÁöÑÁèçË¥µÊ∂≤‰Ωì', expValue: 30000, requiredLevel: 22, type: 'exp' },
            { id: 'shen_dan', name: 'Á•û‰∏π', emoji: 'üî•', description: 'Ëï¥Âê´Á•ûÂäõÁöÑÁÅ´ÁÑ∞‰∏πËçØ', expValue: 50000, requiredLevel: 26, type: 'exp' },
            { id: 'tai_ji_dan', name: 'Â§™ÊûÅ‰∏π', emoji: '‚òØÔ∏è', description: 'Ëï¥Âê´Èò¥Èò≥‰πãÂäõÁöÑÁªàÊûÅ‰∏πËçØ', expValue: 80000, requiredLevel: 30, type: 'exp' },
            { id: 'hun_dun_dan', name: 'Ê∑∑Ê≤å‰∏π', emoji: 'üå™Ô∏è', description: 'Ëï¥Âê´Ê∑∑Ê≤åËÉΩÈáèÁöÑÁ•ûÁßò‰∏πËçØ', expValue: 100000, requiredLevel: 35, type: 'exp' },
            { id: 'qian_kun_dan', name: '‰πæÂù§‰∏π', emoji: 'üåå', description: 'Ëï¥Âê´ÂÆáÂÆô‰πãÂÆùÁöÑËá≥Â∞ä‰∏πËçØ', expValue: 150000, requiredLevel: 40, type: 'exp' },

            // ÁîüÂëΩÂ±ûÊÄßÁâ©ÂìÅ
            { id: 'health_grass', name: 'ËøòÈ≠ÇËçâ', emoji: 'üåø', description: 'Á•ûÂ•áÁöÑ‰ªôËçâÔºåÊúçÁî®ÂêéÊ∞∏‰πÖÊèêÂçáÁîüÂëΩ‰∏äÈôê', statType: 'health', statValue: 5, requiredLevel: 5, type: 'stat' },
            { id: 'health_essence', name: 'ÁîüÂëΩÁ≤æÈ≠Ñ', emoji: 'üíö', description: 'ÂáùËÅöÁöÑÁîüÂëΩÁ≤æÂçéÔºåÂ§ßÂπÖÊèêÂçáÁîüÂëΩ‰∏äÈôê', statType: 'health', statValue: 15, requiredLevel: 15, type: 'stat' },
            { id: 'health_crystal', name: 'ÁîüÂëΩÊ∞¥Êô∂', emoji: 'üíé', description: 'Ëï¥Âê´Á∫ØÁ≤πÁîüÂëΩËÉΩÈáèÁöÑÊ∞¥Êô∂ÔºåÊûÅÂ§ßÊèêÂçáÁîüÂëΩ‰∏äÈôê', statType: 'health', statValue: 50, requiredLevel: 30, type: 'stat' },

            // ÂÜÖÂäõÂ±ûÊÄßÁâ©ÂìÅ
            { id: 'mana_herb', name: 'ÁÅµÊ∞îËçâ', emoji: 'üå±', description: 'Ëï¥Âê´ÁÅµÊ∞îÁöÑ‰ªôËçâÔºåÊúçÁî®ÂêéÊ∞∏‰πÖÊèêÂçáÂÜÖÂäõ‰∏äÈôê', statType: 'mana', statValue: 3, requiredLevel: 3, type: 'stat' },
            { id: 'mana_essence', name: 'ÂÜÖÂäõÁ≤æÈ≠Ñ', emoji: 'üíô', description: 'ÂáùËÅöÁöÑÂÜÖÂäõÁ≤æÂçéÔºåÂ§ßÂπÖÊèêÂçáÂÜÖÂäõ‰∏äÈôê', statType: 'mana', statValue: 10, requiredLevel: 12, type: 'stat' },
            { id: 'mana_crystal', name: 'ÂÜÖÂäõÊ∞¥Êô∂', emoji: 'üîÆ', description: 'Ëï¥Âê´Á∫ØÁ≤πÂÜÖÂäõËÉΩÈáèÁöÑÊ∞¥Êô∂ÔºåÊûÅÂ§ßÊèêÂçáÂÜÖÂäõ‰∏äÈôê', statType: 'mana', statValue: 30, requiredLevel: 25, type: 'stat' },

            // ÊîªÂáªÂ±ûÊÄßÁâ©ÂìÅ
            { id: 'attack_pearl', name: 'ÊîªÂáªÁèçÁè†', emoji: '‚ö™', description: 'Ëï¥Âê´ÊîªÂáªÂäõÁöÑÁ•ûÂ•áÁèçÁè†ÔºåÊ∞∏‰πÖÊèêÂçáÊîªÂáªÂäõ', statType: 'attack', statValue: 2, requiredLevel: 4, type: 'stat' },
            { id: 'attack_stone', name: 'ÊîªÂáª‰πãÁü≥', emoji: 'üóø', description: 'Âè§‰ª£ÊàòÂ£´ÁöÑÊîªÂáª‰πãÁü≥ÔºåÂ§ßÂπÖÊèêÂçáÊîªÂáªÂäõ', statType: 'attack', statValue: 8, requiredLevel: 18, type: 'stat' },
            { id: 'attack_crystal', name: 'ÊîªÂáªÊ∞¥Êô∂', emoji: '‚ö°', description: 'Ëï¥Âê´Âº∫Â§ßÊîªÂáªËÉΩÈáèÁöÑÊ∞¥Êô∂ÔºåÊûÅÂ§ßÊèêÂçáÊîªÂáªÂäõ', statType: 'attack', statValue: 25, requiredLevel: 35, type: 'stat' },

            // Èò≤Âæ°Â±ûÊÄßÁâ©ÂìÅ
            { id: 'defense_scale', name: 'Èò≤Âæ°È≥ûÁâá', emoji: 'üî∏', description: 'ÈæôÊóèÁöÑÈò≤Âæ°È≥ûÁâáÔºåÊ∞∏‰πÖÊèêÂçáÈò≤Âæ°Âäõ', statType: 'defense', statValue: 1, requiredLevel: 6, type: 'stat' },
            { id: 'defense_essence', name: 'Èò≤Âæ°Á≤æÈ≠Ñ', emoji: 'üõ°Ô∏è', description: 'ÂáùËÅöÁöÑÈò≤Âæ°Á≤æÂçéÔºåÂ§ßÂπÖÊèêÂçáÈò≤Âæ°Âäõ', statType: 'defense', statValue: 5, requiredLevel: 20, type: 'stat' },
            { id: 'defense_crystal', name: 'Èò≤Âæ°Ê∞¥Êô∂', emoji: 'üí†', description: 'Ëï¥Âê´Á∫ØÁ≤πÈò≤Âæ°ËÉΩÈáèÁöÑÊ∞¥Êô∂ÔºåÊûÅÂ§ßÊèêÂçáÈò≤Âæ°Âäõ', statType: 'defense', statValue: 20, requiredLevel: 40, type: 'stat' },

            // ÂëΩ‰∏≠Â±ûÊÄßÁâ©ÂìÅ
            { id: 'accuracy_feather', name: 'ÂëΩ‰∏≠ÁæΩÊØõ', emoji: 'ü™∂', description: 'ËΩªÁõàÁöÑÈ≠îÊ≥ïÁæΩÊØõÔºåÊ∞∏‰πÖÊèêÂçáÂëΩ‰∏≠Áéá', statType: 'accuracy', statValue: 3, requiredLevel: 8, type: 'stat' },
            { id: 'accuracy_eye', name: 'Èπ∞ÁúºÁü≥', emoji: 'üëÅÔ∏è', description: 'Ëï¥Âê´Èπ∞‰πãÁúºÂäõÁöÑÂÆùÁü≥ÔºåÂ§ßÂπÖÊèêÂçáÂëΩ‰∏≠Áéá', statType: 'accuracy', statValue: 10, requiredLevel: 22, type: 'stat' },
            { id: 'accuracy_crystal', name: 'ÂëΩ‰∏≠Ê∞¥Êô∂', emoji: 'üéØ', description: 'Ëï¥Âê´Á≤æÂáÜËÉΩÈáèÁöÑÊ∞¥Êô∂ÔºåÊûÅÂ§ßÊèêÂçáÂëΩ‰∏≠Áéá', statType: 'accuracy', statValue: 35, requiredLevel: 45, type: 'stat' },

            // Èó™ÈÅøÂ±ûÊÄßÁâ©ÂìÅ
            { id: 'evasion_wind', name: 'È£é‰πãÊÅØ', emoji: 'üå¨Ô∏è', description: 'Ëï¥Âê´È£é‰πãÁ≤æÂçéÁöÑÁâ©ÂìÅÔºåÊ∞∏‰πÖÊèêÂçáÈó™ÈÅøÁéá', statType: 'evasion', statValue: 2, requiredLevel: 7, type: 'stat' },
            { id: 'evasion_shadow', name: 'ÊöóÂΩ±ÊñóÁØ∑', emoji: 'ü¶á', description: 'ÊöóÂΩ±ÁºñÁªáÁöÑÊñóÁØ∑ÔºåÂ§ßÂπÖÊèêÂçáÈó™ÈÅøÁéá', statType: 'evasion', statValue: 7, requiredLevel: 16, type: 'stat' },
            { id: 'evasion_crystal', name: 'Èó™ÈÅøÊ∞¥Êô∂', emoji: 'üí®', description: 'Ëï¥Âê´ÁÅµÂä®ËÉΩÈáèÁöÑÊ∞¥Êô∂ÔºåÊûÅÂ§ßÊèêÂçáÈó™ÈÅøÁéá', statType: 'evasion', statValue: 25, requiredLevel: 38, type: 'stat' },

            // Êö¥ÂáªÂ±ûÊÄßÁâ©ÂìÅ
            { id: 'crit_fang', name: 'Êö¥ÂáªÂ∞ñÁâô', emoji: 'ü¶∑', description: 'ÁåõÂÖΩÁöÑÂ∞ñÁâôÔºåÊ∞∏‰πÖÊèêÂçáÊö¥ÂáªÁéá', statType: 'crit', statValue: 1, requiredLevel: 10, type: 'stat' },
            { id: 'crit_claw', name: 'Êö¥ÂáªÂà©Áà™', emoji: 'üêæ', description: 'ÁåõÂÖΩÁöÑÂà©Áà™ÔºåÂ§ßÂπÖÊèêÂçáÊö¥ÂáªÁéá', statType: 'crit', statValue: 4, requiredLevel: 28, type: 'stat' },
            { id: 'crysta_crystal', name: 'Êö¥ÂáªÊ∞¥Êô∂', emoji: 'üí•', description: 'Ëï¥Âê´Êö¥ÂáªËÉΩÈáèÁöÑÊ∞¥Êô∂ÔºåÊûÅÂ§ßÊèêÂçáÊö¥ÂáªÁéá', statType: 'crit', statValue: 15, requiredLevel: 50, type: 'stat' },

            // Êö¥ÂáªÈò≤Âæ°Â±ûÊÄßÁâ©ÂìÅ
            { id: 'crit_def_horn', name: 'Èò≤Âæ°Â∞ñËßí', emoji: 'ü¶è', description: 'ÁäÄÁâõÁöÑÈò≤Âæ°Â∞ñËßíÔºåÊ∞∏‰πÖÊèêÂçáÊö¥ÂáªÈò≤Âæ°', statType: 'critDef', statValue: 1, requiredLevel: 12, type: 'stat' },
            { id: 'crit_def_shield', name: 'Êö¥ÂáªÊä§Áõæ', emoji: 'üõ°Ô∏è', description: 'Ëï¥Âê´Èò≤Âæ°ËÉΩÈáèÁöÑÊä§ÁõæÔºåÂ§ßÂπÖÊèêÂçáÊö¥ÂáªÈò≤Âæ°', statType: 'critDef', statValue: 3, requiredLevel: 32, type: 'stat' },
            { id: 'crit_def_crystal', name: 'Èò≤Âæ°Ê∞¥Êô∂', emoji: 'üî∞', description: 'Ëï¥Âê´ÂùöÈüßËÉΩÈáèÁöÑÊ∞¥Êô∂ÔºåÊûÅÂ§ßÊèêÂçáÊö¥ÂáªÈò≤Âæ°', statType: 'critDef', statValue: 12, requiredLevel: 55, type: 'stat' },

            // Ë£ÖÂ§áÁâ©ÂìÅ - Ê≠¶Âô®
            { id: 'iron_sword', name: 'ÈìÅÂâë', emoji: 'üó°Ô∏è', description: 'ÊôÆÈÄöÁöÑÈìÅÂâë', requiredLevel: 15, type: 'equipment', slot: 'weapon', stats: { attack: 5 } },
            { id: 'steel_blade', name: 'Èí¢ÂàÉ', emoji: '‚öîÔ∏è', description: 'Á≤æÈí¢ÊâìÈÄ†ÁöÑÂà©ÂàÉ', requiredLevel: 25, type: 'equipment', slot: 'weapon', stats: { attack: 12 } },
            { id: 'jade_sword', name: 'ÁéâÂâë', emoji: 'üíé', description: 'ÁæéÁéâÊâìÈÄ†ÁöÑÂâë', requiredLevel: 35, type: 'equipment', slot: 'weapon', stats: { attack: 20, crit: 2 } },
            { id: 'dragon_blade', name: 'ÈæôÂàÉ', emoji: 'üêâ', description: '‰º†ËØ¥‰∏≠ÁöÑÈæô‰πãÂàÉ', requiredLevel: 50, type: 'equipment', slot: 'weapon', stats: { attack: 35, crit: 5 } },

            // Ë£ÖÂ§áÁâ©ÂìÅ - Êä§ËÖï
            { id: 'leather_wrist', name: 'ÁöÆÊä§ËÖï', emoji: 'ü¶Ø', description: 'ÁÆÄÂçïÁöÑÁöÆÊä§ËÖï', requiredLevel: 15, type: 'equipment', slot: 'wristguard', stats: { defense: 2 } },
            { id: 'iron_wrist', name: 'ÈìÅÊä§ËÖï', emoji: 'ü¶æ', description: 'ÈìÅÂà∂ÁöÑÊä§ËÖï', requiredLevel: 25, type: 'equipment', slot: 'wristguard', stats: { defense: 5, health: 10 } },
            { id: 'jade_wrist', name: 'ÁéâÊä§ËÖï', emoji: 'üíö', description: 'ÁéâÂà∂Êä§ËÖï', requiredLevel: 40, type: 'equipment', slot: 'wristguard', stats: { defense: 10, health: 25 } },

            // Ë£ÖÂ§áÁâ©ÂìÅ - È°πÈìæ
            { id: 'copper_necklace', name: 'ÈìúÈ°πÈìæ', emoji: 'üìø', description: 'ÊôÆÈÄöÁöÑÈìúÈ°πÈìæ', requiredLevel: 15, type: 'equipment', slot: 'necklace', stats: { mana: 5 } },
            { id: 'silver_necklace', name: 'Èì∂È°πÈìæ', emoji: 'üîó', description: 'Èì∂Âà∂È°πÈìæ', requiredLevel: 30, type: 'equipment', slot: 'necklace', stats: { mana: 15, accuracy: 3 } },
            { id: 'gold_necklace', name: 'ÈáëÈ°πÈìæ', emoji: '‚≠ï', description: 'ÈáëÂà∂È°πÈìæ', requiredLevel: 45, type: 'equipment', slot: 'necklace', stats: { mana: 30, accuracy: 5, evasion: 3 } },

            // Ë£ÖÂ§áÁâ©ÂìÅ - ÊâãÂ•ó
            { id: 'cloth_gloves', name: 'Â∏ÉÊâãÂ•ó', emoji: 'üß§', description: 'ÁÆÄÂçïÁöÑÂ∏ÉÊâãÂ•ó', requiredLevel: 15, type: 'equipment', slot: 'gloves', stats: { accuracy: 2 } },
            { id: 'leather_gloves', name: 'ÁöÆÊâãÂ•ó', emoji: 'üß•', description: 'ÁöÆÂà∂ÊâãÂ•ó', requiredLevel: 28, type: 'equipment', slot: 'gloves', stats: { accuracy: 5, attack: 3 } },
            { id: 'dragon_gloves', name: 'ÈæôÁöÆÊâãÂ•ó', emoji: 'üê≤', description: 'ÈæôÁöÆÂà∂ÊàêÁöÑÊâãÂ•ó', requiredLevel: 42, type: 'equipment', slot: 'gloves', stats: { accuracy: 8, attack: 8, crit: 3 } },

            // Ë£ÖÂ§áÁâ©ÂìÅ - Â§¥Áõî
            { id: 'leather_helmet', name: 'ÁöÆÂ§¥Áõî', emoji: '‚õëÔ∏è', description: 'ÁÆÄÂçïÁöÑÁöÆÂ§¥Áõî', requiredLevel: 15, type: 'equipment', slot: 'helmet', stats: { defense: 3, health: 5 } },
            { id: 'iron_helmet', name: 'ÈìÅÂ§¥Áõî', emoji: 'ü™ñ', description: 'ÈìÅÂà∂Â§¥Áõî', requiredLevel: 30, type: 'equipment', slot: 'helmet', stats: { defense: 8, health: 15 } },
            { id: 'knight_helmet', name: 'È™ëÂ£´Â§¥Áõî', emoji: 'üõ°Ô∏è', description: 'Á≤æËâØÁöÑÈ™ëÂ£´Â§¥Áõî', requiredLevel: 48, type: 'equipment', slot: 'helmet', stats: { defense: 15, health: 30, critDef: 2 } },

            // Ë£ÖÂ§áÁâ©ÂìÅ - Êä§Áî≤
            { id: 'cloth_armor', name: 'Â∏ÉÁî≤', emoji: 'üëï', description: 'ÁÆÄÂçïÁöÑÂ∏ÉÁî≤', requiredLevel: 15, type: 'equipment', slot: 'armor', stats: { defense: 4 } },
            { id: 'leather_armor', name: 'ÁöÆÁî≤', emoji: 'ü¶∫', description: 'ÁöÆÂà∂Êä§Áî≤', requiredLevel: 32, type: 'equipment', slot: 'armor', stats: { defense: 10, health: 20 } },
            { id: 'plate_armor', name: 'ÊùøÁî≤', emoji: 'üõ°Ô∏è', description: 'ÈáçÂûãÊùøÁî≤', requiredLevel: 50, type: 'equipment', slot: 'armor', stats: { defense: 20, health: 40, evasion: -3 } },

            // Ë£ÖÂ§áÁâ©ÂìÅ - Êä§ËÇ©
            { id: 'leather_shoulder', name: 'ÁöÆÊä§ËÇ©', emoji: 'üéΩ', description: 'ÁÆÄÂçïÁöÑÁöÆÊä§ËÇ©', requiredLevel: 15, type: 'equipment', slot: 'shoulder', stats: { defense: 2 } },
            { id: 'iron_shoulder', name: 'ÈìÅÊä§ËÇ©', emoji: '‚öôÔ∏è', description: 'ÈìÅÂà∂Êä§ËÇ©', requiredLevel: 35, type: 'equipment', slot: 'shoulder', stats: { defense: 7, health: 12 } },
            { id: 'dragon_shoulder', name: 'ÈæôÈ≥ûÊä§ËÇ©', emoji: 'üêâ', description: 'ÈæôÈ≥ûÂà∂ÊàêÁöÑÊä§ËÇ©', requiredLevel: 52, type: 'equipment', slot: 'shoulder', stats: { defense: 12, health: 25, critDef: 3 } },

            // Ë£ÖÂ§áÁâ©ÂìÅ - Èù¥Â≠ê
            { id: 'cloth_boots', name: 'Â∏ÉÈù¥', emoji: 'üë¢', description: 'ÁÆÄÂçïÁöÑÂ∏ÉÈù¥', requiredLevel: 15, type: 'equipment', slot: 'boots', stats: { evasion: 2 } },
            { id: 'leather_boots', name: 'ÁöÆÈù¥', emoji: 'ü•æ', description: 'ÁöÆÂà∂Èù¥Â≠ê', requiredLevel: 30, type: 'equipment', slot: 'boots', stats: { evasion: 5, accuracy: 2 } },
            { id: 'wind_boots', name: 'È£éÁ•û‰πãÈù¥', emoji: 'üí®', description: 'Ëï¥Âê´È£é‰πãÂäõÁöÑÈù¥Â≠ê', requiredLevel: 45, type: 'equipment', slot: 'boots', stats: { evasion: 10, accuracy: 5 } }
        ];

        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let level = 1;
        let currentExp = 0;
        let nextLevelExp = 100;
        let currentSceneId = 0; // ÂΩìÂâçÂú∫ÊôØID
        let currentExpRate = scenes[0].expRate; // ÂΩìÂâçÁªèÈ™åËé∑ÂèñÈÄüÁéá
        const clickExpGain = 10; // ÁÇπÂáªÊåâÈíÆËé∑ÂæóÁöÑÁªèÈ™å
        let backpack = new Array(25).fill(null); // ËÉåÂåÖÔºö25‰∏™Ê†ºÂ≠ê
        let unlockedSlots = 5; // Â∑≤Ëß£ÈîÅÁöÑÊ†ºÂ≠êÊï∞Èáè

        // Ë£ÖÂ§áÁä∂ÊÄÅ
        let equippedItems = {
            weapon: null,
            wristguard: null,
            necklace: null,
            gloves: null,
            helmet: null,
            armor: null,
            shoulder: null,
            boots: null
        };

        // ÈáéÊÄ™Êï∞ÊçÆÔºà15Á∫ßÂêéÁöÑÂú∫ÊôØÔºâ
        const monsters = {
            3: { name: 'Èõ™Â±±Èõ™‰∫∫', emoji: 'üëπ', baseHealth: 80, baseAttack: 8, baseDefense: 3, baseAccuracy: 75, baseEvasion: 15 },
            4: { name: 'Ê¥ûÁ©¥ËùôËù†', emoji: 'ü¶á', baseHealth: 100, baseAttack: 10, baseDefense: 4, baseAccuracy: 78, baseEvasion: 18 },
            5: { name: 'ÈÉΩÂ∏ÇÊµÅÊ∞ì', emoji: 'ü•∑', baseHealth: 120, baseAttack: 12, baseDefense: 5, baseAccuracy: 80, baseEvasion: 20 },
            6: { name: 'Ê∑±Êµ∑Â∑®ÂÖΩ', emoji: 'ü¶à', baseHealth: 150, baseAttack: 15, baseDefense: 6, baseAccuracy: 82, baseEvasion: 22 },
            7: { name: 'Ê≤ôÊº†ËùéÂ≠ê', emoji: 'ü¶Ç', baseHealth: 180, baseAttack: 18, baseDefense: 7, baseAccuracy: 84, baseEvasion: 24 },
            8: { name: 'ÊòüÁ©∫È≠îÁÅµ', emoji: 'üëª', baseHealth: 210, baseAttack: 21, baseDefense: 8, baseAccuracy: 86, baseEvasion: 26 },
            9: { name: 'Ê®±Ëä±Ê†ëÂ¶ñ', emoji: 'üå≥', baseHealth: 250, baseAttack: 24, baseDefense: 9, baseAccuracy: 88, baseEvasion: 28 },
            10: { name: 'ÈÅóËøπÂÆàÂç´', emoji: 'üóø', baseHealth: 300, baseAttack: 28, baseDefense: 10, baseAccuracy: 90, baseEvasion: 30 },
            11: { name: 'ÁÅ´ÁÑ∞ÊÅ∂È≠î', emoji: 'üòà', baseHealth: 350, baseAttack: 32, baseDefense: 11, baseAccuracy: 92, baseEvasion: 32 },
            12: { name: 'ÂΩ©ËôπÂπªÂÖΩ', emoji: 'ü¶Ñ', baseHealth: 400, baseAttack: 36, baseDefense: 12, baseAccuracy: 94, baseEvasion: 34 },
            13: { name: '‰∫ëÁ´ØÂ§©‰Ωø', emoji: 'üëº', baseHealth: 460, baseAttack: 40, baseDefense: 13, baseAccuracy: 95, baseEvasion: 36 },
            14: { name: 'Ê∞¥Êô∂È≠îÂÉè', emoji: 'üíé', baseHealth: 520, baseAttack: 45, baseDefense: 14, baseAccuracy: 96, baseEvasion: 38 },
            15: { name: 'ÊûÅÂÖâÂ∑®Èæô', emoji: 'üê≤', baseHealth: 600, baseAttack: 50, baseDefense: 15, baseAccuracy: 97, baseEvasion: 40 },
            16: { name: 'È≠îÊ≥ïÂ∑´Â¶ñ', emoji: 'üßô', baseHealth: 680, baseAttack: 55, baseDefense: 16, baseAccuracy: 98, baseEvasion: 42 },
            17: { name: 'ËøúÂè§Â∑®Èæô', emoji: 'üêâ', baseHealth: 780, baseAttack: 60, baseDefense: 18, baseAccuracy: 99, baseEvasion: 44 },
            18: { name: 'Â§©ÁïåÊàòÁ•û', emoji: '‚öîÔ∏è', baseHealth: 900, baseAttack: 65, baseDefense: 20, baseAccuracy: 100, baseEvasion: 45 },
            19: { name: 'ËôöÁ©∫È¢Ü‰∏ª', emoji: 'üåÄ', baseHealth: 1000, baseAttack: 70, baseDefense: 22, baseAccuracy: 100, baseEvasion: 46 }
        };

        // Á®ÄÊúâË£ÖÂ§áÊéâËêΩË°®ÔºàÊàòËÉúÈáéÊÄ™Ëé∑ÂæóÔºâ
        const rareEquipmentDrops = [
            // È´òÁ∫ßÊ≠¶Âô®
            { id: 'flame_blade', name: 'ÁÉàÁÑ∞‰πãÂàÉ', emoji: 'üî•', slot: 'weapon', requiredLevel: 20, stats: { attack: 18, crit: 3 } },
            { id: 'frost_sword', name: 'ÂÜ∞Èúú‰πãÂâë', emoji: '‚ùÑÔ∏è', slot: 'weapon', requiredLevel: 30, stats: { attack: 28, crit: 4, accuracy: 5 } },
            { id: 'thunder_god_blade', name: 'Èõ∑Á•û‰πãÂàÉ', emoji: '‚ö°', slot: 'weapon', requiredLevel: 40, stats: { attack: 40, crit: 6, accuracy: 8 } },
            { id: 'divine_weapon', name: 'Á•ûÂú£‰πãÂô®', emoji: '‚ú®', slot: 'weapon', requiredLevel: 50, stats: { attack: 55, crit: 8, accuracy: 10 } },

            // È´òÁ∫ßÊä§ËÖï
            { id: 'titan_wrist', name: 'Ê≥∞Âù¶Êä§ËÖï', emoji: 'üí™', slot: 'wristguard', requiredLevel: 25, stats: { defense: 12, health: 30 } },
            { id: 'dragon_wrist', name: 'ÈæôÈ™®Êä§ËÖï', emoji: 'ü¶¥', slot: 'wristguard', requiredLevel: 35, stats: { defense: 18, health: 45, attack: 5 } },

            // È´òÁ∫ßÈ°πÈìæ
            { id: 'soul_necklace', name: 'ÁÅµÈ≠ÇÈ°πÈìæ', emoji: 'üìø', slot: 'necklace', requiredLevel: 30, stats: { mana: 40, accuracy: 8, evasion: 5 } },
            { id: 'divine_necklace', name: 'Á•ûÂú£È°πÈìæ', emoji: '‚≠ï', slot: 'necklace', requiredLevel: 45, stats: { mana: 60, accuracy: 10, evasion: 8, crit: 3 } },

            // È´òÁ∫ßÊâãÂ•ó
            { id: 'assassin_gloves', name: 'Âà∫ÂÆ¢ÊâãÂ•ó', emoji: 'ü•ä', slot: 'gloves', requiredLevel: 28, stats: { accuracy: 10, attack: 10, crit: 5 } },
            { id: 'paladin_gloves', name: 'Âú£È™ëÂ£´ÊâãÂ•ó', emoji: 'üõ°Ô∏è', slot: 'gloves', requiredLevel: 42, stats: { accuracy: 12, attack: 12, defense: 5, crit: 4 } },

            // È´òÁ∫ßÂ§¥Áõî
            { id: 'dragon_king_helmet', name: 'ÈæôÁéãÂ§¥Áõî', emoji: 'üëë', slot: 'helmet', requiredLevel: 35, stats: { defense: 18, health: 40, critDef: 3 } },
            { id: 'immortal_helmet', name: '‰∏çÊúΩÂ§¥Áõî', emoji: '‚≠ê', slot: 'helmet', requiredLevel: 50, stats: { defense: 25, health: 50, critDef: 5 } },

            // È´òÁ∫ßÊä§Áî≤
            { id: 'dragon_scale_armor', name: 'ÈæôÈ≥ûÁî≤', emoji: 'üêâ', slot: 'armor', requiredLevel: 38, stats: { defense: 25, health: 50, evasion: -2 } },
            { id: 'divine_armor', name: 'Á•ûÂú£Êä§Áî≤', emoji: 'üåü', slot: 'armor', requiredLevel: 52, stats: { defense: 30, health: 60, critDef: 4 } },

            // È´òÁ∫ßÊä§ËÇ©
            { id: 'phoenix_shoulder', name: 'Âá§Âá∞Êä§ËÇ©', emoji: 'üî•', slot: 'shoulder', requiredLevel: 40, stats: { defense: 15, health: 30, attack: 8 } },
            { id: 'titan_shoulder', name: 'Ê≥∞Âù¶Êä§ËÇ©', emoji: '‚õ∞Ô∏è', slot: 'shoulder', requiredLevel: 55, stats: { defense: 20, health: 40, critDef: 5 } },

            // È´òÁ∫ßÈù¥Â≠ê
            { id: 'lightning_boots', name: 'Èó™ÁîµÈù¥', emoji: '‚ö°', slot: 'boots', requiredLevel: 35, stats: { evasion: 15, accuracy: 8 } },
            { id: 'teleport_boots', name: 'Áû¨ÁßªÈù¥', emoji: 'üí´', slot: 'boots', requiredLevel: 48, stats: { evasion: 20, accuracy: 10, crit: 2 } }
        ];

        // ÊàòÊñóÁ≥ªÁªüÁä∂ÊÄÅ
        let battleTimer = null;
        let battleCountdown = 30;
        let isBattling = false;

        // Áé©ÂÆ∂Â±ûÊÄßÁ≥ªÁªü
        const playerAttributes = {
            health: { base: 100, growth: 10, icon: '‚ù§Ô∏è', name: 'ÁîüÂëΩ' },
            mana: { base: 50, growth: 5, icon: 'üíô', name: 'ÂÜÖÂäõ' },
            attack: { base: 10, growth: 2, icon: '‚öîÔ∏è', name: 'ÊîªÂáª' },
            defense: { base: 5, growth: 1, icon: 'üõ°Ô∏è', name: 'Èò≤Âæ°' },
            accuracy: { base: 80, growth: 3, icon: 'üéØ', name: 'ÂëΩ‰∏≠' },
            evasion: { base: 20, growth: 2, icon: 'üí®', name: 'Èó™ÈÅø' },
            crit: { base: 5, growth: 1, icon: '‚ö°', name: 'Êö¥Âáª' },
            critDef: { base: 3, growth: 1, icon: 'üõ°Ô∏è', name: 'Êö¥ÂáªÈò≤Âæ°' }
        };

        // ËÆ°ÁÆóÂ±ûÊÄßÂÄº
        function calculateAttribute(attributeName) {
            const attr = playerAttributes[attributeName];
            return attr.base + (level - 1) * attr.growth;
        }

        // Ëé∑ÂèñÊâÄÊúâÂ±ûÊÄßÂÄº
        function getAllAttributes() {
            const attributes = {};
            for (const key in playerAttributes) {
                attributes[key] = calculateAttribute(key);
            }
            return attributes;
        }

        // DOM ÂÖÉÁ¥†
        const levelEl = document.getElementById('level');
        const currentExpEl = document.getElementById('current-exp');
        const nextLevelExpEl = document.getElementById('next-level-exp');
        const progressFill = document.getElementById('progress-fill');
        const expRateEl = document.getElementById('exp-rate');
        const gainExpBtn = document.getElementById('gain-exp-btn');
        const levelUpBtn = document.getElementById('level-up-btn');
        const resetBtn = document.getElementById('reset-btn');
        const quickLevelBtn = document.getElementById('quick-level-btn');
        const sceneSwitchBtn = document.getElementById('scene-switch-btn');
        const scenePanel = document.getElementById('scene-panel');
        const closeSceneBtn = document.getElementById('close-scene-btn');
        const sceneList = document.getElementById('scene-list');
        const currentSceneEmojiEl = document.getElementById('current-scene-emoji');
        const currentSceneNameEl = document.getElementById('current-scene-name');
        const playerAvatarEl = document.getElementById('player-avatar');
        const backpackBtn = document.getElementById('backpack-btn');
        const backpackPanel = document.getElementById('backpack-panel');
        const closeBackpackBtn = document.getElementById('close-backpack-btn');
        const backpackGrid = document.getElementById('backpack-grid');
        const attributesBtn = document.getElementById('attributes-btn');
        const attributesPanel = document.getElementById('attributes-panel');
        const closeAttributesBtn = document.getElementById('close-attributes-btn');
        const attributesGrid = document.getElementById('attributes-grid');
        const equipmentBtn = document.getElementById('equipment-btn');
        const equipmentPanel = document.getElementById('equipment-panel');
        const closeEquipmentBtn = document.getElementById('close-equipment-btn');
        const battleTimerEl = document.getElementById('battle-timer');
        const battleCountdownEl = document.getElementById('battle-countdown');
        const battleOverlay = document.getElementById('battle-overlay');
        const battleLog = document.getElementById('battle-log');

        // Êõ¥Êñ∞ÊòæÁ§∫
        function updateDisplay() {
            levelEl.textContent = level;
            currentExpEl.textContent = Math.floor(currentExp);
            nextLevelExpEl.textContent = nextLevelExp;

            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            const progress = (currentExp / nextLevelExp) * 100;
            progressFill.style.width = `${progress}%`;

            // Êõ¥Êñ∞ÂçáÁ∫ßÊåâÈíÆÁä∂ÊÄÅ
            levelUpBtn.disabled = currentExp < nextLevelExp;

            // Êõ¥Êñ∞Âú∫ÊôØÂàáÊç¢ÊåâÈíÆÁä∂ÊÄÅÔºà5Á∫ßËß£ÈîÅÔºâ
            sceneSwitchBtn.disabled = level < 5;

            // Êõ¥Êñ∞ËÉåÂåÖÊåâÈíÆÁä∂ÊÄÅÔºà3Á∫ßËß£ÈîÅÔºâ
            backpackBtn.disabled = level < 3;

            // Êõ¥Êñ∞Â±ûÊÄßÊåâÈíÆÁä∂ÊÄÅÔºà9Á∫ßËß£ÈîÅÔºâ
            attributesBtn.disabled = level < 9;

            // Êõ¥Êñ∞Ë£ÖÂ§áÊåâÈíÆÁä∂ÊÄÅÔºà15Á∫ßËß£ÈîÅÔºâ
            equipmentBtn.disabled = level < 15;

            // Êõ¥Êñ∞ÁªèÈ™åÈÄüÁéáÊòæÁ§∫
            expRateEl.textContent = currentExpRate;
        }

        // ËÆ°ÁÆóÂçáÁ∫ßÊâÄÈúÄÁªèÈ™å
        function getNextLevelExp(lvl) {
            return Math.floor(100 * Math.pow(1.2, lvl - 1));
        }

        // ÂçáÁ∫ß
        function levelUp() {
            const oldUnlockedSlots = unlockedSlots;
            level++;
            currentExp = currentExp - nextLevelExp;
            nextLevelExp = getNextLevelExp(level);

            // ÈáçÊñ∞ËÆ°ÁÆóËß£ÈîÅÁöÑÊ†ºÂ≠êÊï∞
            unlockedSlots = calculateUnlockedSlots();

            // Ê£ÄÊü•ÊòØÂê¶Ëß£ÈîÅ‰∫ÜÊñ∞ÁöÑÊ†ºÂ≠ê
            if (unlockedSlots > oldUnlockedSlots) {
                showSlotUnlockNotification(unlockedSlots);
            }

            // ÊòæÁ§∫ÂçáÁ∫ßÈÄöÁü•
            showLevelUpNotification();

            // Êí≠ÊîæÂçáÁ∫ßÂä®ÁîªÊïàÊûú
            levelEl.style.animation = 'none';
            levelEl.offsetHeight; // Ëß¶ÂèëÈáçÊéí
            levelEl.style.animation = 'bounce 0.5s ease 3';
        }

        // Âø´ÈÄüÂçáÁ∫ßÔºàË∞ÉËØïÂäüËÉΩÔºåÊó†ËßÜÁªèÈ™åÔºâ
        function quickLevelUp() {
            const oldUnlockedSlots = unlockedSlots;
            level++;
            currentExp = 0; // ÈáçÁΩÆÂΩìÂâçÁªèÈ™å
            nextLevelExp = getNextLevelExp(level);

            // ÈáçÊñ∞ËÆ°ÁÆóËß£ÈîÅÁöÑÊ†ºÂ≠êÊï∞
            unlockedSlots = calculateUnlockedSlots();

            // Ê£ÄÊü•ÊòØÂê¶Ëß£ÈîÅ‰∫ÜÊñ∞ÁöÑÊ†ºÂ≠ê
            if (unlockedSlots > oldUnlockedSlots) {
                showSlotUnlockNotification(unlockedSlots);
            }

            // ÊòæÁ§∫ÂçáÁ∫ßÈÄöÁü•
            showLevelUpNotification();

            // Êí≠ÊîæÂçáÁ∫ßÂä®ÁîªÊïàÊûú
            levelEl.style.animation = 'none';
            levelEl.offsetHeight; // Ëß¶ÂèëÈáçÊéí
            levelEl.style.animation = 'bounce 0.5s ease 3';

            // Êõ¥Êñ∞ÊòæÁ§∫
            updateDisplay();
        }

        // ÊòæÁ§∫ÂçáÁ∫ßÈÄöÁü•
        function showLevelUpNotification() {
            const notification = document.createElement('div');
            notification.className = 'level-up-notification';
            notification.textContent = `üéâ ÂçáÁ∫ß‰∫ÜÔºÅÁé∞Âú®ÊòØ Lv.${level}ÔºÅ`;
            notification.style.top = '80px'; // Êîπ‰∏∫‰ªéÈ°∂ÈÉ®80pxÂºÄÂßã
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 2500);
        }

        // ÊòæÁ§∫ÁªèÈ™åËé∑ÂæóÊïàÊûú
        function showExpGain(amount, x, y) {
            const expGain = document.createElement('div');
            expGain.className = 'exp-gain';
            expGain.textContent = `+${amount}`;
            expGain.style.left = `${x}px`;
            expGain.style.top = `${y}px`;
            document.body.appendChild(expGain);

            setTimeout(() => {
                expGain.remove();
            }, 1000);
        }

        // ÊòæÁ§∫ÁªèÈ™å‰∏çË∂≥ÈÄöÁü•
        function showInsufficientExpNotification() {
            const notification = document.createElement('div');
            notification.className = 'insufficient-exp-notification';
            notification.textContent = `‚ùå ÁªèÈ™å‰∏çË∂≥ÔºÅËøòÈúÄË¶Å ${nextLevelExp - currentExp} ÁªèÈ™å`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // ===== ÊàòÊñóÁ≥ªÁªü =====

        // ÂêØÂä®ÊàòÊñóËÆ°Êó∂Âô®
        function startBattleTimer() {
            // Âè™Êúâ15Á∫ß‰ª•‰∏ä‰∏îÂú®ÈáéÊÄ™Âú∫ÊôØÊâçÂêØÂä®
            if (level < 15 || currentSceneId < 3) {
                battleTimerEl.classList.remove('active');
                if (battleTimer) {
                    clearInterval(battleTimer);
                    battleTimer = null;
                }
                return;
            }

            battleTimerEl.classList.add('active');
            battleCountdown = 30;
            battleCountdownEl.textContent = battleCountdown;

            if (battleTimer) {
                clearInterval(battleTimer);
            }

            battleTimer = setInterval(() => {
                battleCountdown--;
                battleCountdownEl.textContent = battleCountdown;

                if (battleCountdown <= 0) {
                    clearInterval(battleTimer);
                    battleTimer = null;
                    triggerBattle();
                }
            }, 1000);
        }

        // ÂÅúÊ≠¢ÊàòÊñóËÆ°Êó∂Âô®
        function stopBattleTimer() {
            if (battleTimer) {
                clearInterval(battleTimer);
                battleTimer = null;
            }
            battleTimerEl.classList.remove('active');
            battleCountdown = 30;
        }

        // Ëß¶ÂèëÊàòÊñó
        function triggerBattle() {
            if (isBattling) return;
            isBattling = true;

            const monster = monsters[currentSceneId];
            if (!monster) return;

            // ÊòæÁ§∫ÊàòÊñóÁïåÈù¢
            battleOverlay.style.display = 'flex';
            battleOverlay.classList.add('active');
            battleLog.innerHTML = '';

            // Êõ¥Êñ∞ÈáéÊÄ™ÊòæÁ§∫
            document.getElementById('monster-emoji').textContent = monster.emoji;
            document.getElementById('monster-name').textContent = monster.name;

            // ËÆ°ÁÆóÁé©ÂÆ∂ÂíåÈáéÊÄ™ÁöÑÂ±ûÊÄß
            const playerStats = calculatePlayerBattleStats();
            const monsterStats = calculateMonsterBattleStats(monster);

            // Êõ¥Êñ∞HPÊòæÁ§∫
            document.getElementById('player-max-hp').textContent = playerStats.health;
            document.getElementById('player-hp').textContent = playerStats.health;
            document.getElementById('monster-max-hp').textContent = monsterStats.health;
            document.getElementById('monster-hp').textContent = monsterStats.health;

            // ÂºÄÂßãÊàòÊñóÂæ™ÁéØ
            simulateBattle(playerStats, monsterStats);
        }

        // ËÆ°ÁÆóÁé©ÂÆ∂ÊàòÊñóÂ±ûÊÄß
        function calculatePlayerBattleStats() {
            const baseStats = getAllAttributes();
            let stats = { ...baseStats };

            // Âä†‰∏äË£ÖÂ§áÂ±ûÊÄß
            for (const slot in equippedItems) {
                const item = equippedItems[slot];
                if (item && item.stats) {
                    for (const stat in item.stats) {
                        if (stats[stat] !== undefined) {
                            stats[stat] += item.stats[stat];
                        }
                    }
                }
            }

            return stats;
        }

        // ËÆ°ÁÆóÈáéÊÄ™ÊàòÊñóÂ±ûÊÄß
        function calculateMonsterBattleStats(monster) {
            // ÈáéÊÄ™Â±ûÊÄßÈöèÂú∫ÊôØÁ≠âÁ∫ßÊèêÂçá
            const sceneLevel = scenes[currentSceneId].unlockLevel;
            const levelMultiplier = 1 + (sceneLevel - 15) * 0.1; // ÊØèÁ∫ßÂº∫10%

            return {
                health: Math.floor(monster.baseHealth * levelMultiplier),
                attack: Math.floor(monster.baseAttack * levelMultiplier),
                defense: Math.floor(monster.baseDefense * levelMultiplier),
                accuracy: monster.baseAccuracy,
                evasion: monster.baseEvasion
            };
        }

        // Ê®°ÊãüÊàòÊñó
        async function simulateBattle(playerStats, monsterStats) {
            let playerHP = playerStats.health;
            let monsterHP = monsterStats.health;
            const maxPlayerHP = playerStats.health;
            const maxMonsterHP = monsterStats.health;

            addBattleLog('‚öîÔ∏è ÊàòÊñóÂºÄÂßãÔºÅ', 'neutral');

            // ÊàòÊñóÂæ™ÁéØÔºåÊúÄÂ§ö20ÂõûÂêà
            for (let round = 1; round <= 20; round++) {
                await delay(800);

                // Áé©ÂÆ∂ÊîªÂáª
                if (Math.random() * 100 < playerStats.accuracy) {
                    // ÂëΩ‰∏≠
                    if (Math.random() * 100 < monsterStats.evasion) {
                        addBattleLog('üí® ÈáéÊÄ™Èó™ÈÅø‰∫Ü‰Ω†ÁöÑÊîªÂáªÔºÅ', 'monster-attack');
                    } else {
                        let damage = Math.max(1, playerStats.attack - monsterStats.defense);

                        // Êö¥ÂáªÂà§ÂÆö
                        if (Math.random() * 100 < playerStats.crit) {
                            damage = Math.floor(damage * 1.5);
                            addBattleLog(`üí• Êö¥ÂáªÔºÅ‰Ω†ÈÄ†Êàê‰∫Ü ${damage} ÁÇπ‰º§ÂÆ≥ÔºÅ`, 'player-attack');
                        } else {
                            addBattleLog(`‚öîÔ∏è ‰Ω†ÈÄ†Êàê‰∫Ü ${damage} ÁÇπ‰º§ÂÆ≥ÔºÅ`, 'player-attack');
                        }

                        monsterHP -= damage;

                        // Áé©ÂÆ∂ÊîªÂáªÂä®Áîª
                        const playerEl = document.getElementById('battle-player');
                        playerEl.classList.add('attacking-right');
                        setTimeout(() => playerEl.classList.remove('attacking-right'), 300);
                    }
                } else {
                    addBattleLog('‚ùå ‰Ω†ÁöÑÊîªÂáªÊú™ÂëΩ‰∏≠ÔºÅ', 'player-attack');
                }

                // Êõ¥Êñ∞ÈáéÊÄ™HP
                document.getElementById('monster-hp').textContent = Math.max(0, monsterHP);

                // Ê£ÄÊü•ÈáéÊÄ™ÊòØÂê¶Ê≠ª‰∫°
                if (monsterHP <= 0) {
                    await delay(500);
                    addBattleLog('üéâ ËÉúÂà©ÔºÅ‰Ω†ÂáªË¥•‰∫ÜÈáéÊÄ™ÔºÅ', 'victory');
                    await delay(1000);
                    handleBattleVictory();
                    return;
                }

                await delay(800);

                // ÈáéÊÄ™ÊîªÂáª
                if (Math.random() * 100 < monsterStats.accuracy) {
                    // ÂëΩ‰∏≠
                    if (Math.random() * 100 < playerStats.evasion) {
                        addBattleLog('üí® ‰Ω†Èó™ÈÅø‰∫ÜÈáéÊÄ™ÁöÑÊîªÂáªÔºÅ', 'player-attack');
                    } else {
                        let damage = Math.max(1, monsterStats.attack - playerStats.defense);

                        // Êö¥ÂáªÈò≤Âæ°Âà§ÂÆö
                        const critDef = playerStats.critDef || 0;
                        if (Math.random() * 100 < critDef) {
                            damage = Math.floor(damage * 0.5);
                            addBattleLog(`üõ°Ô∏è Êö¥ÂáªÈò≤Âæ°ÔºÅ‰Ω†Âè™ÂèóÂà∞ ${damage} ÁÇπ‰º§ÂÆ≥ÔºÅ`, 'monster-attack');
                        } else {
                            addBattleLog(`üëπ ÈáéÊÄ™ÈÄ†Êàê‰∫Ü ${damage} ÁÇπ‰º§ÂÆ≥ÔºÅ`, 'monster-attack');
                        }

                        playerHP -= damage;

                        // ÈáéÊÄ™ÊîªÂáªÂä®Áîª
                        const monsterEl = document.getElementById('battle-monster');
                        monsterEl.classList.add('attacking-left');
                        setTimeout(() => monsterEl.classList.remove('attacking-left'), 300);
                    }
                } else {
                    addBattleLog('‚ú® ÈáéÊÄ™ÁöÑÊîªÂáªÊú™ÂëΩ‰∏≠ÔºÅ', 'monster-attack');
                }

                // Êõ¥Êñ∞Áé©ÂÆ∂HP
                document.getElementById('player-hp').textContent = Math.max(0, playerHP);

                // Ê£ÄÊü•Áé©ÂÆ∂ÊòØÂê¶Ê≠ª‰∫°
                if (playerHP <= 0) {
                    await delay(500);
                    addBattleLog('üíÄ Â§±Ë¥•ÔºÅ‰Ω†Ë¢´ÈáéÊÄ™ÂáªË¥•‰∫ÜÔºÅ', 'defeat');
                    await delay(1000);
                    handleBattleDefeat();
                    return;
                }
            }

            // 20ÂõûÂêàÂêéÔºåÊ†πÊçÆHPÂà§Êñ≠ËÉúË¥ü
            if (playerHP > monsterHP) {
                addBattleLog('üéâ Êó∂Èó¥Âà∞ÔºÅ‰Ω†‰ª•ÂæÆÂº±‰ºòÂäøËé∑ËÉúÔºÅ', 'victory');
                await delay(1000);
                handleBattleVictory();
            } else {
                addBattleLog('üíÄ Êó∂Èó¥Âà∞ÔºÅ‰Ω†ÊÉúË¥•ÔºÅ', 'defeat');
                await delay(1000);
                handleBattleDefeat();
            }
        }

        // Âª∂Êó∂ÂáΩÊï∞
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Ê∑ªÂä†ÊàòÊñóÊó•Âøó
        function addBattleLog(message, type) {
            const entry = document.createElement('div');
            entry.className = `battle-log-entry ${type}`;
            entry.textContent = message;
            battleLog.appendChild(entry);
            battleLog.scrollTop = battleLog.scrollHeight;
        }

        // Â§ÑÁêÜÊàòÊñóËÉúÂà©
        function handleBattleVictory() {
            // ÂÖ≥Èó≠ÊàòÊñóÁïåÈù¢
            battleOverlay.classList.remove('active');
            setTimeout(() => {
                battleOverlay.style.display = 'none';
            }, 300);

            isBattling = false;

            // ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™Á®ÄÊúâË£ÖÂ§á
            const availableEquipment = rareEquipmentDrops.filter(eq => eq.requiredLevel <= level);
            if (availableEquipment.length > 0) {
                const randomEquipment = availableEquipment[Math.floor(Math.random() * availableEquipment.length)];

                // ÂàõÂª∫ÂÆåÊï¥ÁöÑË£ÖÂ§áÁâ©ÂìÅ
                const equipmentItem = {
                    ...randomEquipment,
                    type: 'equipment',
                    description: `ÂáªË¥•ÈáéÊÄ™Ëé∑ÂæóÁöÑÁ®ÄÊúâË£ÖÂ§áÔºÅÈúÄË¶ÅLv.${randomEquipment.requiredLevel}`
                };

                // Ê∑ªÂä†Âà∞ËÉåÂåÖ
                const success = addToBackpack(equipmentItem);
                if (success) {
                    // ÊòæÁ§∫Ëé∑ÂæóË£ÖÂ§áÈÄöÁü•
                    const notification = document.createElement('div');
                    notification.className = 'drop-notification';
                    notification.textContent = `üéâ ÊàòÊñóËÉúÂà©ÔºÅËé∑Âæó‰∫ÜÁ®ÄÊúâË£ÖÂ§á ${equipmentItem.emoji} ${equipmentItem.name}ÔºÅ`;
                    notification.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
                    notification.style.top = '340px';
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }
            }

            // ÈáçÊñ∞ÂºÄÂßãËÆ°Êó∂
            startBattleTimer();
        }

        // Â§ÑÁêÜÊàòÊñóÂ§±Ë¥•
        function handleBattleDefeat() {
            // ÂÖ≥Èó≠ÊàòÊñóÁïåÈù¢
            battleOverlay.classList.remove('active');
            setTimeout(() => {
                battleOverlay.style.display = 'none';
            }, 300);

            isBattling = false;

            // ÊòæÁ§∫Â§±Ë¥•ÈÄöÁü•
            const notification = document.createElement('div');
            notification.className = 'battle-notification';
            notification.textContent = 'üíÄ ÂÆûÂäõ‰∏çÊµéË¢´ÊâìÊ≠ª‰∫ÜÔºÅ';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 2000);

            // ÈÄÄÂõûÂà∞ÂàùÂßãÂú∫ÊôØ
            switchScene(0);
        }

        // Â¢ûÂä†ÁªèÈ™å
        function addExp(amount) {
            currentExp += amount;
            updateDisplay();
        }

        // Ê£ÄÊµãÊéâËêΩ
        function checkForDrop(sceneId) {
            const drops = sceneDrops[sceneId];
            if (!drops) return;

            for (const drop of drops) {
                if (Math.random() < drop.probability) {
                    const item = itemTypes.find(item => item.id === drop.itemId);
                    if (item) {
                        addToBackpack(item);
                        return item;
                    }
                }
            }
            return null;
        }

        // Ê∑ªÂä†Áâ©ÂìÅÂà∞ËÉåÂåÖ
        function addToBackpack(item) {
            // Êü•ÊâæÊòØÂê¶Â∑≤ÊúâÁõ∏ÂêåÁâ©ÂìÅ
            let existingSlot = -1;
            for (let i = 0; i < unlockedSlots; i++) {
                if (backpack[i] && backpack[i].id === item.id) {
                    existingSlot = i;
                    break;
                }
            }

            if (existingSlot >= 0) {
                // Â†ÜÂè†Âà∞Â∑≤ÊúâÁâ©ÂìÅ
                backpack[existingSlot].count++;
            } else {
                // ÂØªÊâæÁ©∫Ê†ºÂ≠ê
                let emptySlot = -1;
                for (let i = 0; i < unlockedSlots; i++) {
                    if (!backpack[i]) {
                        emptySlot = i;
                        break;
                    }
                }

                if (emptySlot >= 0) {
                    // Ê∑ªÂä†Âà∞Á©∫Ê†ºÂ≠ê
                    backpack[emptySlot] = {
                        ...item,
                        count: 1
                    };
                } else {
                    // ËÉåÂåÖÊª°‰∫Ü
                    showBackpackFullNotification();
                    return false;
                }
            }

            return true;
        }

        // ÊòæÁ§∫ÊéâËêΩÂä®Áîª
        function showDropAnimation(item, backpackRect) {
            const avatarEl = document.querySelector('.avatar');
            const avatarRect = avatarEl.getBoundingClientRect();

            const dropAnim = document.createElement('div');
            dropAnim.className = 'item-drop-animation';
            dropAnim.textContent = item.emoji;
            dropAnim.style.left = avatarRect.left + avatarRect.width / 2 + 'px';
            dropAnim.style.top = avatarRect.top + avatarRect.height / 2 + 'px';

            // ËÆ°ÁÆó‰∏≠Èó¥ÁÇπÂíåÁõÆÊ†áÁÇπÔºåËÆ©Âä®Áîª‰ªéËßíËâ≤Âà∞Âè≥‰∏äËßíÔºåÈÅøÂÖçÈÅÆÊå°‰∏≠ÂøÉÂå∫Âüü
            const gameContainer = document.querySelector('.game-container');
            const containerRect = gameContainer.getBoundingClientRect();

            // ÁõÆÊ†áÁÇπÊîπ‰∏∫Ê∏∏ÊàèÂÆπÂô®Âè≥‰∏äËßíÂå∫Âüü
            const targetX = containerRect.right - 100 - avatarRect.left - avatarRect.width / 2;
            const targetY = containerRect.top + 50 - avatarRect.top - avatarRect.height / 2;

            // ‰∏≠Èó¥ÁÇπÁ®çÂæÆÂÅèÁßªÔºåÂΩ¢ÊàêÂºßÂΩ¢
            const midX = targetX / 2;
            const midY = (targetY - 100) / 2;

            dropAnim.style.setProperty('--mid-x', midX + 'px');
            dropAnim.style.setProperty('--mid-y', midY + 'px');
            dropAnim.style.setProperty('--target-x', targetX + 'px');
            dropAnim.style.setProperty('--target-y', targetY + 'px');

            document.body.appendChild(dropAnim);

            setTimeout(() => {
                dropAnim.remove();
            }, 1500);
        }

        // ÊòæÁ§∫ÊéâËêΩÈÄöÁü•
        function showDropNotification(item) {
            const notification = document.createElement('div');
            notification.className = 'drop-notification';
            notification.textContent = `üéâ Ëé∑Âæó‰∫Ü ${item.emoji} ${item.name}ÔºÅ`;
            notification.style.top = '180px'; // ÊîæÂú®Êõ¥‰∏ãÊñπÔºå‰∏çÊå°‰ΩèÂú∫ÊôØ‰ø°ÊÅØ
            notification.style.transform = 'translate(-50%, -50%)'; // ‰øùÊåÅÂ±Ö‰∏≠
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // ÊòæÁ§∫ËÉåÂåÖÊª°ÈÄöÁü•
        function showBackpackFullNotification() {
            const notification = document.createElement('div');
            notification.className = 'backpack-full-notification';
            notification.textContent = 'üîí ËÉåÂåÖÂ∑≤Êª°ÔºåÊó†Ê≥ïËé∑ÂæóÊõ¥Â§öÁâ©ÂìÅÔºÅ';
            notification.style.top = '220px'; // ÊîæÂú®ÊéâËêΩÈÄöÁü•‰∏ãÊñπ
            notification.style.transform = 'translate(-50%, -50%)'; // ‰øùÊåÅÂ±Ö‰∏≠
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // Ëá™Âä®ÁªèÈ™åÂ¢ûÈïø
        setInterval(() => {
            addExp(currentExpRate);

            // Ê£ÄÊµãÊéâËêΩ
            const droppedItem = checkForDrop(currentSceneId);
            if (droppedItem) {
                const backpackRect = backpackBtn.getBoundingClientRect();
                showDropAnimation(droppedItem, backpackRect);
                showDropNotification(droppedItem);
                renderBackpack();
            }
        }, 1000); // ÊØèÁßíÂ¢ûÂä† currentExpRate ÁÇπÁªèÈ™å

        // ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        gainExpBtn.addEventListener('click', (e) => {
            const rect = gainExpBtn.getBoundingClientRect();
            const x = e.clientX;
            const y = e.clientY;

            addExp(clickExpGain);
            showExpGain(clickExpGain, x, y);
        });

        // ÂçáÁ∫ßÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        levelUpBtn.addEventListener('click', () => {
            if (currentExp >= nextLevelExp) {
                levelUp();
            } else {
                showInsufficientExpNotification();
            }
        });

        // ËÆ°ÁÆóËß£ÈîÅÁöÑÊ†ºÂ≠êÊï∞Èáè
        function calculateUnlockedSlots() {
            // ÂàùÂßã5‰∏™Ê†ºÂ≠êÔºåÊØè3Á∫ßËß£ÈîÅ1‰∏™ÔºåÊúÄÂ§ö25‰∏™
            const baseSlots = 5;
            const slotsPerLevel = 3;
            return Math.min(25, baseSlots + Math.floor((level - 1) / slotsPerLevel));
        }

        // ÂàùÂßãÂåñËÉåÂåÖÁâ©ÂìÅ
        function initializeBackpack() {
            backpack = new Array(25).fill(null);

            // ËÉåÂåÖÂàùÂßã‰∏∫Á©∫ÔºåÁâ©ÂìÅÈÄöËøáÊéâËêΩËé∑Âæó

            // ËÆ°ÁÆóÂ∑≤Ëß£ÈîÅÁöÑÊ†ºÂ≠êÊï∞
            unlockedSlots = calculateUnlockedSlots();
        }

        // ÈáçÁΩÆÊ∏∏Êàè
        function resetGame() {
            level = 1;
            currentExp = 0;
            nextLevelExp = 100;
            currentSceneId = 0;
            currentExpRate = scenes[0].expRate;
            initializeBackpack();
            updateSceneDisplay();
            updateDisplay();
        }

        // Ê∏≤ÊüìËÉåÂåÖ
        function renderBackpack() {
            backpackGrid.innerHTML = '';

            backpack.forEach((item, index) => {
                const slot = document.createElement('div');

                // Ê£ÄÊü•Ê†ºÂ≠êÊòØÂê¶Â∑≤Ëß£ÈîÅ
                if (index < unlockedSlots) {
                    slot.className = 'backpack-slot';

                    if (item) {
                        slot.classList.add('clickable');
                        slot.textContent = item.emoji;
                        if (item.count > 1) {
                            const countBadge = document.createElement('div');
                            countBadge.className = 'item-count';
                            countBadge.textContent = item.count;
                            slot.appendChild(countBadge);
                        }

                        // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                        slot.addEventListener('click', () => useItem(index));

                        // Ê∑ªÂä†Èº†Ê†áÊÇ¨ÂÅú‰∫ã‰ª∂
                        slot.addEventListener('mouseenter', (e) => showItemTooltip(e, item));
                        slot.addEventListener('mouseleave', hideItemTooltip);
                        slot.addEventListener('mousemove', moveItemTooltip);
                    } else {
                        slot.classList.add('empty');
                        slot.textContent = '‚óã';
                    }
                } else {
                    // ÈîÅÂÆöÁöÑÊ†ºÂ≠ê
                    slot.className = 'backpack-slot locked';
                    const unlockLevel = 5 + index * 3; // ËÆ°ÁÆóËß£ÈîÅÁ≠âÁ∫ß
                    const unlockText = document.createElement('div');
                    unlockText.className = 'unlock-level';
                    unlockText.textContent = unlockLevel;
                    slot.appendChild(unlockText);
                }

                backpackGrid.appendChild(slot);
            });
        }

        // ÊâìÂºÄËÉåÂåÖ
        function openBackpack() {
            if (level < 3) {
                showLockedNotification('ËÉåÂåÖÂäüËÉΩÈúÄË¶ÅËææÂà∞ 3 Á∫ßÊâçËÉΩËß£ÈîÅÔºÅ');
                return;
            }
            renderBackpack();
            backpackPanel.classList.add('active');
        }

        // ÂÖ≥Èó≠ËÉåÂåÖ
        function closeBackpack() {
            backpackPanel.classList.remove('active');
        }

        // ÊòæÁ§∫Á≠âÁ∫ß‰∏çË∂≥ÊèêÁ§∫
        function showLevelRequirementNotification() {
            const notification = document.createElement('div');
            notification.className = 'locked-notification';
            notification.textContent = `üîí Áé©ÂÆ∂Á≠âÁ∫ßÊú™ËææÂà∞Áâ©ÂìÅÈúÄË¶ÅÁ≠âÁ∫ßÔºÅ`;
            notification.style.background = 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // ÊòæÁ§∫Ê†ºÂ≠êËß£ÈîÅÈÄöÁü•
        function showSlotUnlockNotification(slotsCount) {
            const notification = document.createElement('div');
            notification.className = 'level-up-notification';
            notification.textContent = `üéâ Ëß£ÈîÅ‰∫ÜÊñ∞ÁöÑËÉåÂåÖÊ†ºÂ≠êÔºÅÁé∞Âú®ÊòØ ${slotsCount} ‰∏™Ê†ºÂ≠êÔºÅ`;
            notification.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
            notification.style.top = '140px'; // ÊîæÂú®ÂçáÁ∫ßÊ∂àÊÅØ‰∏ãÊñπ
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 2500);
        }

        // Ê∏≤ÊüìÂ±ûÊÄßÈù¢Êùø
        function renderAttributesPanel() {
            attributesGrid.innerHTML = '';
            const attributes = getAllAttributes();

            for (const [key, attr] of Object.entries(playerAttributes)) {
                const attributeValue = attributes[key];
                const attrItem = document.createElement('div');
                attrItem.className = `attribute-item attribute-${key}`;

                attrItem.innerHTML = `
                    <div class="attribute-name">
                        <span class="attribute-icon">${attr.icon}</span>
                        ${attr.name}
                    </div>
                    <div class="attribute-value">${attributeValue}</div>
                    <div class="attribute-growth">ÊØèÁ∫ß +${attr.growth}</div>
                `;

                attributesGrid.appendChild(attrItem);
            }
        }

        // ÊâìÂºÄÂ±ûÊÄßÈù¢Êùø
        function openAttributesPanel() {
            if (level < 9) {
                showLockedNotification('Â±ûÊÄßÈù¢ÊùøÈúÄË¶ÅËææÂà∞ 9 Á∫ßÊâçËÉΩËß£ÈîÅÔºÅ');
                return;
            }
            renderAttributesPanel();
            attributesPanel.classList.add('active');
        }

        // ÂÖ≥Èó≠Â±ûÊÄßÈù¢Êùø
        function closeAttributesPanel() {
            attributesPanel.classList.remove('active');
        }

        // Ê∏≤ÊüìË£ÖÂ§áÈù¢Êùø
        function renderEquipmentPanel() {
            // Êõ¥Êñ∞8‰∏™Ë£ÖÂ§áÊßΩÁöÑÊòæÁ§∫
            const slotNames = ['weapon', 'wristguard', 'necklace', 'gloves', 'helmet', 'armor', 'shoulder', 'boots'];

            slotNames.forEach(slotName => {
                const equippedItem = equippedItems[slotName];
                const iconEl = document.getElementById(`slot-${slotName}`);
                const nameEl = document.getElementById(`name-${slotName}`);

                if (equippedItem) {
                    iconEl.textContent = equippedItem.emoji;
                    nameEl.textContent = equippedItem.name;
                    nameEl.classList.remove('empty');
                } else {
                    nameEl.textContent = 'Á©∫';
                    nameEl.classList.add('empty');
                }
            });
        }

        // ÊâìÂºÄË£ÖÂ§áÈù¢Êùø
        function openEquipmentPanel() {
            if (level < 15) {
                showLockedNotification('Ë£ÖÂ§áÁ≥ªÁªüÈúÄË¶ÅËææÂà∞ 15 Á∫ßÊâçËÉΩËß£ÈîÅÔºÅ');
                return;
            }
            renderEquipmentPanel();
            equipmentPanel.classList.add('active');
        }

        // ÂÖ≥Èó≠Ë£ÖÂ§áÈù¢Êùø
        function closeEquipmentPanel() {
            equipmentPanel.classList.remove('active');
        }

        // ‰ΩøÁî®Áâ©ÂìÅ
        function useItem(index) {
            const item = backpack[index];
            if (!item) return;

            // Ê£ÄÊü•Áé©ÂÆ∂Á≠âÁ∫ßÊòØÂê¶ËææÂà∞Áâ©ÂìÅË¶ÅÊ±Ç
            if (level < item.requiredLevel) {
                showLevelRequirementNotification();
                return;
            }

            if (item.type === 'exp') {
                // ÁªèÈ™åÁâ©ÂìÅ
                addExp(item.expValue);

                // ÊòæÁ§∫ÁªèÈ™åËé∑ÂæóÊïàÊûúÔºàÂú®ËÉåÂåÖÊåâÈíÆ‰ΩçÁΩÆÔºâ
                const rect = backpackBtn.getBoundingClientRect();
                showExpGain(item.expValue, rect.right + 10, rect.top);

                // ÂáèÂ∞ëÁâ©ÂìÅÊï∞Èáè
                item.count--;
                if (item.count <= 0) {
                    backpack[index] = null;
                }

            } else if (item.type === 'stat') {
                // Â±ûÊÄßÁâ©ÂìÅ
                applyStatBonus(item);

                // ÊòæÁ§∫Â±ûÊÄßÊèêÂçáÈÄöÁü•
                showStatBonusNotification(item);

                // ÂáèÂ∞ëÁâ©ÂìÅÊï∞Èáè
                item.count--;
                if (item.count <= 0) {
                    backpack[index] = null;
                }

            } else if (item.type === 'equipment') {
                // Ë£ÖÂ§áÁâ©ÂìÅ - Ë£ÖÂ§áËÄå‰∏çÊòØÊ∂àËÄó
                equipItem(item, index);
                return; // Ë£ÖÂ§á‰∏çÊ∂àËÄóÁâ©ÂìÅÔºåÊâÄ‰ª•Áõ¥Êé•ËøîÂõû
            }

            // ÈöêËóèÊâÄÊúâTips
            hideItemTooltip();

            // ÈáçÊñ∞Ê∏≤ÊüìËÉåÂåÖ
            renderBackpack();
        }

        // Â∫îÁî®Â±ûÊÄßÂä†Êàê
        function applyStatBonus(item) {
            if (item.statType && item.statValue) {
                // Âú®ËøôÈáåÊ∞∏‰πÖÂ¢ûÂä†Â±ûÊÄß
                // Áî±‰∫éÊàë‰ª¨ÁöÑÂ±ûÊÄßÁ≥ªÁªüÊòØÂü∫‰∫éÁ≠âÁ∫ßËÆ°ÁÆóÁöÑÔºåËøôÈáåÂèØ‰ª•Â≠òÂÇ®‰∏Ä‰∏™Âä†ÊàêÂÄº
                // ‰∏∫‰∫ÜÁÆÄÂçïËµ∑ËßÅÔºåÊàë‰ª¨ÊöÇÊó∂ÊòæÁ§∫‰∏Ä‰∏™ÊèêÁ§∫
                console.log(`Â¢ûÂä†‰∫Ü ${item.statValue} ÁÇπ ${item.statType} Â±ûÊÄß`);
            }
        }

        // Ë£ÖÂ§áÁâ©ÂìÅ
        function equipItem(item, backpackIndex) {
            const slot = item.slot;

            // Â¶ÇÊûúËØ•ÊßΩ‰ΩçÂ∑≤ÊúâË£ÖÂ§áÔºåÂÖàÂç∏‰∏ãÊóßË£ÖÂ§áÔºàËøîÂõûËÉåÂåÖÔºâ
            if (equippedItems[slot]) {
                const oldItem = equippedItems[slot];
                addToBackpack(oldItem);
            }

            // Ë£ÖÂ§áÊñ∞Áâ©ÂìÅ
            equippedItems[slot] = item;

            // ‰ªéËÉåÂåÖ‰∏≠ÁßªÈô§ËØ•Áâ©ÂìÅÔºàÂõ†‰∏∫Ë£ÖÂ§á‰∏çÊ∂àËÄóÔºå‰ΩÜÈúÄË¶Å‰ªéËÉåÂåÖÁßªÈô§Ôºâ
            backpack[backpackIndex] = null;

            // ÊòæÁ§∫Ë£ÖÂ§áÈÄöÁü•
            showEquipNotification(item);

            // ÈöêËóèÊâÄÊúâTips
            hideItemTooltip();

            // ÈáçÊñ∞Ê∏≤ÊüìËÉåÂåÖ
            renderBackpack();

            // Â¶ÇÊûúË£ÖÂ§áÈù¢ÊùøÊâìÂºÄÔºåÈáçÊñ∞Ê∏≤Êüì
            if (equipmentPanel.classList.contains('active')) {
                renderEquipmentPanel();
            }
        }

        // ÊòæÁ§∫Ë£ÖÂ§áÈÄöÁü•
        function showEquipNotification(item) {
            const notification = document.createElement('div');
            notification.className = 'drop-notification';
            notification.textContent = `üéâ Ë£ÖÂ§á‰∫Ü ${item.emoji} ${item.name}ÔºÅ`;
            notification.style.top = '300px'; // ÊîæÂú®Êõ¥‰∏ãÊñπ
            notification.style.transform = 'translate(-50%, -50%)';
            notification.style.background = 'linear-gradient(135deg, #E91E63 0%, #C2185B 100%)';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // ÊòæÁ§∫Â±ûÊÄßÊèêÂçáÈÄöÁü•
        function showStatBonusNotification(item) {
            const notification = document.createElement('div');
            notification.className = 'drop-notification';
            notification.textContent = `üéâ Ê∞∏‰πÖÊèêÂçá‰∫Ü ${item.statValue} ÁÇπ ${getAttributeName(item.statType)}ÔºÅ`;
            notification.style.top = '260px'; // ÊîæÂú®ËÉåÂåÖÊª°Ê∂àÊÅØ‰∏ãÊñπ
            notification.style.transform = 'translate(-50%, -50%)';
            notification.style.background = 'linear-gradient(135deg, #9c27b0 0%, #673ab7 100%)';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // Ëé∑ÂèñÂ±ûÊÄß‰∏≠ÊñáÂêç
        function getAttributeName(statType) {
            const attributeNames = {
                health: 'ÁîüÂëΩ',
                mana: 'ÂÜÖÂäõ',
                attack: 'ÊîªÂáª',
                defense: 'Èò≤Âæ°',
                accuracy: 'ÂëΩ‰∏≠',
                evasion: 'Èó™ÈÅø',
                crit: 'Êö¥Âáª',
                critDef: 'Êö¥ÂáªÈò≤Âæ°'
            };
            return attributeNames[statType] || statType;
        }

        // ÊòæÁ§∫Áâ©ÂìÅÊèêÁ§∫
        let tooltip = null;

        function showItemTooltip(e, item) {
            tooltip = document.createElement('div');
            tooltip.className = 'item-tooltip';

            // Ê£ÄÊü•Áé©ÂÆ∂Á≠âÁ∫ßÊòØÂê¶Êª°Ë∂≥Ë¶ÅÊ±Ç
            const levelCheck = level >= item.requiredLevel;
            const levelColor = levelCheck ? '#4CAF50' : '#ff6b6b';

            let effectHtml = '';
            if (item.type === 'exp') {
                effectHtml = `<div class="item-effect">ÊïàÊûúÔºö+${item.expValue} ÁªèÈ™å</div>`;
            } else if (item.type === 'stat') {
                effectHtml = `<div class="item-effect" style="color: #9c27b0;">Ê∞∏‰πÖÊèêÂçáÔºö+${item.statValue} ${getAttributeName(item.statType)}</div>`;
            } else if (item.type === 'equipment') {
                // Ë£ÖÂ§áÁâ©ÂìÅ - ÊòæÁ§∫ÊâÄÊúâÂ±ûÊÄßÂä†Êàê
                const slotNames = {
                    weapon: 'Ê≠¶Âô®',
                    wristguard: 'Êä§ËÖï',
                    necklace: 'È°πÈìæ',
                    gloves: 'ÊâãÂ•ó',
                    helmet: 'Â§¥Áõî',
                    armor: 'Êä§Áî≤',
                    shoulder: 'Êä§ËÇ©',
                    boots: 'Èù¥Â≠ê'
                };
                effectHtml = `<div class="item-effect" style="color: #E91E63;">Ë£ÖÂ§áÈÉ®‰ΩçÔºö${slotNames[item.slot]}</div>`;

                // ÊòæÁ§∫Ë£ÖÂ§áÂ±ûÊÄß
                if (item.stats) {
                    for (const [stat, value] of Object.entries(item.stats)) {
                        if (value > 0) {
                            effectHtml += `<div class="item-effect" style="color: #4CAF50;">+${value} ${getAttributeName(stat)}</div>`;
                        } else if (value < 0) {
                            effectHtml += `<div class="item-effect" style="color: #ff6b6b;">${value} ${getAttributeName(stat)}</div>`;
                        }
                    }
                }
            }

            tooltip.innerHTML = `
                <div class="item-name">${item.name}</div>
                <div class="item-description">${item.description}</div>
                ${effectHtml}
                <div class="item-level" style="color: ${levelColor}; margin-top: 3px;">
                    ${levelCheck ? '‚úì' : '‚úó'} ÈúÄË¶Å Lv.${item.requiredLevel}
                </div>
            `;
            document.body.appendChild(tooltip);
            moveItemTooltip(e);
        }

        function moveItemTooltip(e) {
            if (!tooltip) return;
            tooltip.style.left = (e.clientX + 10) + 'px';
            tooltip.style.top = (e.clientY - 10) + 'px';
        }

        function hideItemTooltip() {
            if (tooltip) {
                tooltip.remove();
                tooltip = null;
            }
        }

        // ÂàáÊç¢Âú∫ÊôØ
        function switchScene(sceneId) {
            const scene = scenes[sceneId];
            if (!scene || level < scene.unlockLevel) {
                return;
            }

            currentSceneId = sceneId;
            currentExpRate = scene.expRate;
            updateSceneDisplay();
            updateDisplay();
            renderSceneList();
            closeScenePanel();

            // ÂàáÊç¢Âú∫ÊôØÂêéÂêØÂä®ÊàòÊñóËÆ°Êó∂Âô®
            startBattleTimer();
        }

        // Êõ¥Êñ∞Âú∫ÊôØÊòæÁ§∫
        function updateSceneDisplay() {
            const scene = scenes[currentSceneId];
            currentSceneEmojiEl.textContent = scene.emoji;
            currentSceneNameEl.textContent = scene.name;
            // ‰∏çÂÜçÊõ¥Êñ∞ËßíËâ≤Â§¥ÂÉèÔºå‰øùÊåÅÁã¨Á´ã
        }

        // Ê∏≤ÊüìÂú∫ÊôØÂàóË°®
        function renderSceneList() {
            sceneList.innerHTML = '';

            scenes.forEach(scene => {
                const sceneItem = document.createElement('div');
                sceneItem.className = 'scene-item';

                const isLocked = level < scene.unlockLevel;
                const isActive = scene.id === currentSceneId;

                if (isLocked) {
                    sceneItem.classList.add('locked');
                }
                if (isActive) {
                    sceneItem.classList.add('active');
                }

                let dropInfo = '';
                if (!isLocked) {
                    const drops = sceneDrops[scene.id];
                    if (drops && drops.length > 0) {
                        const dropNames = drops.map(drop => {
                            const item = itemTypes.find(item => item.id === drop.itemId);
                            return item ? item.emoji : '';
                        }).filter(emoji => emoji).join(' ');
                        if (dropNames) {
                            dropInfo = `<div style="font-size: 10px; margin-top: 5px;">ÊéâËêΩ: ${dropNames}</div>`;
                        }
                    }
                }

                sceneItem.innerHTML = `
                    <div class="scene-emoji">${isLocked ? 'üîí' : scene.emoji}</div>
                    <div class="scene-name">${isLocked ? '???' : scene.name}</div>
                    <div class="scene-rate">${isLocked ? '' : scene.expRate + ' ÁªèÈ™å/Áßí'}</div>
                    ${dropInfo}
                    ${isLocked ? `<div class="scene-unlock-badge">Lv.${scene.unlockLevel}</div>` : ''}
                `;

                if (!isLocked) {
                    sceneItem.addEventListener('click', () => switchScene(scene.id));
                }

                sceneList.appendChild(sceneItem);
            });
        }

        // ÊâìÂºÄÂú∫ÊôØÈù¢Êùø
        function openScenePanel() {
            if (level < 5) {
                showLockedNotification('Âú∫ÊôØÂàáÊç¢ÂäüËÉΩÈúÄË¶ÅËææÂà∞ 5 Á∫ßÊâçËÉΩËß£ÈîÅÔºÅ');
                return;
            }
            renderSceneList();
            scenePanel.classList.add('active');
        }

        // ÂÖ≥Èó≠Âú∫ÊôØÈù¢Êùø
        function closeScenePanel() {
            scenePanel.classList.remove('active');
        }

        // ÊòæÁ§∫ÂäüËÉΩÈîÅÂÆöÈÄöÁü•
        function showLockedNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'locked-notification';
            notification.textContent = `üîí ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // ÈáçÁΩÆÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        resetBtn.addEventListener('click', resetGame);

        // Âø´ÈÄüÂçáÁ∫ßÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        quickLevelBtn.addEventListener('click', quickLevelUp);

        // Âú∫ÊôØÂàáÊç¢ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        sceneSwitchBtn.addEventListener('click', openScenePanel);

        // ËÉåÂåÖÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        backpackBtn.addEventListener('click', openBackpack);

        // Â±ûÊÄßÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        attributesBtn.addEventListener('click', openAttributesPanel);

        // Ë£ÖÂ§áÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        equipmentBtn.addEventListener('click', openEquipmentPanel);

        // ÂÖ≥Èó≠Ë£ÖÂ§áÈù¢ÊùøÊåâÈíÆ
        closeEquipmentBtn.addEventListener('click', closeEquipmentPanel);

        // ÁÇπÂáªË£ÖÂ§áÈù¢ÊùøÂ§ñÈÉ®ÂÖ≥Èó≠
        equipmentPanel.addEventListener('click', (e) => {
            if (e.target === equipmentPanel) {
                closeEquipmentPanel();
            }
        });

        // ÂÖ≥Èó≠ËÉåÂåÖÊåâÈíÆ
        closeBackpackBtn.addEventListener('click', closeBackpack);

        // ÂÖ≥Èó≠Â±ûÊÄßÈù¢ÊùøÊåâÈíÆ
        closeAttributesBtn.addEventListener('click', closeAttributesPanel);

        // ÁÇπÂáªËÉåÂåÖÈù¢ÊùøÂ§ñÈÉ®ÂÖ≥Èó≠
        backpackPanel.addEventListener('click', (e) => {
            if (e.target === backpackPanel) {
                closeBackpack();
            }
        });

        // ÁÇπÂáªÂ±ûÊÄßÈù¢ÊùøÂ§ñÈÉ®ÂÖ≥Èó≠
        attributesPanel.addEventListener('click', (e) => {
            if (e.target === attributesPanel) {
                closeAttributesPanel();
            }
        });

        // ÂÖ≥Èó≠Âú∫ÊôØÈù¢ÊùøÊåâÈíÆ
        closeSceneBtn.addEventListener('click', closeScenePanel);

        // ÁÇπÂáªÂú∫ÊôØÈù¢ÊùøÂ§ñÈÉ®ÂÖ≥Èó≠
        scenePanel.addEventListener('click', (e) => {
            if (e.target === scenePanel) {
                closeScenePanel();
            }
        });

        // ÂàùÂßãÂåñÊòæÁ§∫
        initializeBackpack();
        updateSceneDisplay();
        updateDisplay();

        // ÂêØÂä®ÊàòÊñóËÆ°Êó∂Âô®
        startBattleTimer();
    </script>
</body>
</html>
